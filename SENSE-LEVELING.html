<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SENSE - Solo Leveling Edition</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

    * {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
    }

    /* Glassmorphism Effect */
    .glass {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
    }

    .glass-dark {
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* Status Window (Solo Leveling style) */
    .status-window {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(30px);
      border: 2px solid rgba(251, 191, 36, 0.3);
      box-shadow: 0 10px 40px rgba(251, 191, 36, 0.2);
    }

    /* Stat Colors */
    .stat-str { color: #f97316; } /* orange */
    .stat-end { color: #22c55e; } /* green */
    .stat-int { color: #3b82f6; } /* blue */
    .stat-cha { color: #a855f7; } /* purple */
    .stat-dis { color: #eab308; } /* yellow */
    .stat-wea { color: #10b981; } /* emerald */

    /* Progress Bars */
    .progress-bar {
      background: linear-gradient(90deg, #fbbf24 0%, #f97316 100%);
      height: 8px;
      border-radius: 4px;
      transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 8px rgba(251, 191, 36, 0.4);
    }

    .progress-container {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 4px;
      overflow: hidden;
    }

    /* Buttons */
    .btn-primary {
      background: linear-gradient(135deg, #fbbf24 0%, #f97316 100%);
      color: white;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(251, 191, 36, 0.4);
    }

    .btn-success {
      background: linear-gradient(135deg, #22c55e 0%, #10b981 100%);
      color: white;
    }

    .btn-complete {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
      border: 2px solid #22c55e;
    }

    /* Task Cards */
    .task-card {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      border: 1px solid rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
    }

    .task-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
    }

    .task-card.completed {
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.3);
    }

    /* Mission Badge */
    .mission-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .badge-daily {
      background: rgba(251, 191, 36, 0.2);
      color: #f59e0b;
      border: 1px solid rgba(251, 191, 36, 0.4);
    }

    .badge-weekly {
      background: rgba(249, 115, 22, 0.2);
      color: #f97316;
      border: 1px solid rgba(249, 115, 22, 0.4);
    }

    .badge-epic {
      background: rgba(168, 85, 247, 0.2);
      color: #a855f7;
      border: 1px solid rgba(168, 85, 247, 0.4);
    }

    /* Countdown Timer */
    .timer-critical {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      animation: pulse 2s infinite;
    }

    .timer-warning {
      background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
      color: white;
    }

    .timer-good {
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      color: white;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .slide-up {
      animation: slideUp 0.5s ease-out;
    }

    /* Stat Explanation Tooltip */
    .stat-tooltip {
      position: relative;
      cursor: help;
    }

    .stat-tooltip:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }

    .tooltip-text {
      visibility: hidden;
      opacity: 0;
      position: absolute;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 11px;
      width: 180px;
      text-align: center;
      transition: opacity 0.3s;
      z-index: 1000;
      backdrop-filter: blur(10px);
    }

    /* Tab Navigation */
    .tab {
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.5);
    }

    .tab.active {
      background: linear-gradient(135deg, #fbbf24 0%, #f97316 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
    }

    /* Level Up Animation */
    @keyframes levelUp {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }

    .level-badge {
      background: linear-gradient(135deg, #fbbf24 0%, #f97316 100%);
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-weight: 700;
      display: inline-block;
      box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4);
    }

    /* Notification Toast */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
      z-index: 9999;
      animation: slideInRight 0.4s ease-out;
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(100px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    /* Debuff Badge */
    .debuff-badge {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #ef4444;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 700;
    }
  </style>
</head>
<body class="p-4 pb-24">
  <div id="app" class="max-w-md mx-auto"></div>

  <script>
    // ==================== STATE ====================
    const STORAGE_KEY = 'sense_leveling_v2';
    const DEFAULT_STATE = {
      currentWeight: 260,
      targetWeight: 175,
      startWeight: 260,
      weightHistory: [{date: new Date().toISOString().split('T')[0], weight: 260}],

      level: 1,
      xp: 0,
      coins: 0,
      streak: 0,
      consecutiveMisses: 0,

      stats: {
        str: 40,
        end: 35,
        int: 70,
        cha: 65,
        dis: 50,
        wea: 55
      },

      debuff: null,
      completed: {},
      taskStreak: {},
      meals: [],
      waterCups: 0,
      calorieTarget: 2100,
      proteinTarget: 190,
      carbTarget: 165,
      fatTarget: 70,

      currentDay: 'push',
      workoutLog: [],
      contentLog: [],
      notificationsEnabled: false,
      lastNotification: null,

      missions: [],
      missionCompletions: {},
      inventory: [],
      journal: [],
      lastDate: new Date().toISOString().split('T')[0],
      currentTab: 'home'
    };

    let state = { ...DEFAULT_STATE };

    // ==================== DAILY TASKS ====================
    const DAILY_TASKS = [
      {
        id: 'bible',
        name: '📖 Read Bible',
        desc: '15 minutes of reading',
        xp: 50,
        coins: 20,
        stats: {dis: 5, int: 2},
        category: 'spiritual'
      },
      {
        id: 'workout',
        name: '💪 Complete Workout',
        desc: 'Push/Pull/Legs routine',
        xp: 100,
        coins: 50,
        stats: {str: 5, end: 5, dis: 3},
        category: 'physical'
      },
      {
        id: 'ai',
        name: '🤖 Learn AI',
        desc: '30-60 minutes of learning',
        xp: 75,
        coins: 30,
        stats: {int: 5, dis: 2},
        category: 'mental'
      },
      {
        id: 'short',
        name: '📱 Short-Form Content',
        desc: 'Create 1+ short video',
        xp: 60,
        coins: 40,
        stats: {cha: 5, wea: 3},
        category: 'creation'
      },
      {
        id: 'long',
        name: '🎬 Long-Form Content',
        desc: 'Create YouTube/Blog post',
        xp: 80,
        coins: 60,
        stats: {cha: 5, wea: 5, int: 3},
        category: 'creation'
      },
      {
        id: 'calories',
        name: '🍽️ Track Calories',
        desc: 'Stay in deficit (2100 cal)',
        xp: 40,
        coins: 25,
        stats: {dis: 3},
        category: 'nutrition'
      },
      {
        id: 'water',
        name: '💧 Drink 8 Cups Water',
        desc: '64 oz throughout day',
        xp: 30,
        coins: 15,
        stats: {end: 2},
        category: 'nutrition'
      }
    ];

    // ==================== MISSIONS ====================
    const MISSIONS = [
      // Daily Missions
      {
        id: 'perfect_day',
        name: 'Perfect Day',
        desc: 'Complete all 7 daily tasks',
        type: 'daily',
        xp: 200,
        coins: 100,
        cooldown: 24,
        check: () => DAILY_TASKS.every(t => state.completed[t.id])
      },
      {
        id: 'workout_complete',
        name: 'Training Complete',
        desc: 'Complete your workout',
        type: 'daily',
        xp: 50,
        coins: 25,
        cooldown: 24,
        check: () => state.completed.workout
      },
      {
        id: 'calorie_deficit',
        name: 'Calorie Deficit',
        desc: 'Stay under 2100 calories',
        type: 'daily',
        xp: 50,
        coins: 25,
        cooldown: 24,
        check: () => {
          const totals = getTotals();
          return totals.cal > 0 && totals.cal <= 2200;
        }
      },

      // Weekly Missions
      {
        id: 'weekly_workouts',
        name: 'Weekly Training',
        desc: 'Complete 6+ workouts this week',
        type: 'weekly',
        xp: 500,
        coins: 250,
        cooldown: 168,
        check: () => {
          const weekWorkouts = state.workoutLog.filter(w => {
            const date = new Date(w.date);
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            return date >= weekAgo;
          });
          return weekWorkouts.length >= 6;
        }
      },
      {
        id: 'weekly_content',
        name: 'Content Creator',
        desc: 'Create 7+ short-form videos this week',
        type: 'weekly',
        xp: 400,
        coins: 200,
        cooldown: 168,
        check: () => {
          const weekContent = state.contentLog.filter(c => {
            const date = new Date(c.date);
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            return date >= weekAgo && c.type === 'short';
          });
          return weekContent.length >= 7;
        }
      },
      {
        id: 'weekly_streak',
        name: '7-Day Streak',
        desc: 'Maintain a 7-day streak',
        type: 'weekly',
        xp: 600,
        coins: 300,
        cooldown: 168,
        check: () => state.streak >= 7
      },

      // Epic Missions
      {
        id: 'weight_milestone',
        name: 'First Milestone',
        desc: 'Lose 10 lbs (260 → 250 lbs)',
        type: 'epic',
        xp: 1000,
        coins: 500,
        cooldown: 0,
        check: () => state.currentWeight <= 250
      },
      {
        id: 'level_10',
        name: 'Level 10 Hunter',
        desc: 'Reach Level 10',
        type: 'epic',
        xp: 2000,
        coins: 1000,
        cooldown: 0,
        check: () => state.level >= 10
      },
      {
        id: 'perfect_month',
        name: 'Perfect Month',
        desc: 'Maintain a 30-day streak',
        type: 'epic',
        xp: 3000,
        coins: 1500,
        cooldown: 0,
        check: () => state.streak >= 30
      }
    ];

    // ==================== STAT EXPLANATIONS ====================
    const STAT_INFO = {
      str: {
        name: 'Strength',
        desc: 'Physical power from workouts',
        color: '#f97316',
        gains: 'Workout tasks, lifting heavy'
      },
      end: {
        name: 'Endurance',
        desc: 'Stamina and resilience',
        color: '#22c55e',
        gains: 'Workouts, water intake, consistency'
      },
      int: {
        name: 'Intelligence',
        desc: 'Knowledge and learning',
        color: '#3b82f6',
        gains: 'AI learning, Bible reading'
      },
      cha: {
        name: 'Charisma',
        desc: 'Influence and communication',
        color: '#a855f7',
        gains: 'Content creation, engagement'
      },
      dis: {
        name: 'Discipline',
        desc: 'Self-control and consistency',
        color: '#eab308',
        gains: 'All daily tasks, maintaining streaks'
      },
      wea: {
        name: 'Wealth',
        desc: 'Financial growth and abundance',
        color: '#10b981',
        gains: 'Content creation, business tasks'
      }
    };

    // ==================== FOOD DATABASE ====================
    const FOOD_DATABASE = [
      { id: 'chicken', name: 'Chicken Breast', serving: '8oz', cal: 280, pro: 52, carb: 0, fat: 6 },
      { id: 'yogurt', name: 'Greek Yogurt', serving: '1 cup', cal: 150, pro: 20, carb: 10, fat: 4 },
      { id: 'eggs', name: 'Eggs', serving: '2 large', cal: 140, pro: 12, carb: 1, fat: 10 },
      { id: 'rice', name: 'White Rice', serving: '1 cup', cal: 200, pro: 4, carb: 45, fat: 0 },
      { id: 'oatmeal', name: 'Oatmeal', serving: '1/2 cup', cal: 150, pro: 5, carb: 27, fat: 3 },
      { id: 'protein', name: 'Protein Shake', serving: '1 scoop', cal: 120, pro: 25, carb: 3, fat: 1 },
      { id: 'banana', name: 'Banana', serving: '1 medium', cal: 105, pro: 1, carb: 27, fat: 0 },
      { id: 'salmon', name: 'Salmon', serving: '6oz', cal: 350, pro: 40, carb: 0, fat: 20 },
      { id: 'broccoli', name: 'Broccoli', serving: '1 cup', cal: 55, pro: 4, carb: 11, fat: 0 },
      { id: 'sweetpotato', name: 'Sweet Potato', serving: '1 medium', cal: 110, pro: 2, carb: 26, fat: 0 },
      { id: 'almonds', name: 'Almonds', serving: '1oz', cal: 160, pro: 6, carb: 6, fat: 14 },
      { id: 'turkey', name: 'Ground Turkey', serving: '4oz', cal: 160, pro: 20, carb: 0, fat: 8 }
    ];

    // ==================== EXERCISES ====================
    const EXERCISES = {
      push: [
        { id: 'bench', name: 'Bench Press', muscle: 'Chest' },
        { id: 'ohp', name: 'Overhead Press', muscle: 'Shoulders' },
        { id: 'incline', name: 'Incline DB Press', muscle: 'Chest' },
        { id: 'lateral', name: 'Lateral Raises', muscle: 'Shoulders' },
        { id: 'dips', name: 'Tricep Dips', muscle: 'Triceps' },
        { id: 'pushdown', name: 'Tricep Pushdowns', muscle: 'Triceps' }
      ],
      pull: [
        { id: 'deadlift', name: 'Deadlifts', muscle: 'Back' },
        { id: 'pullup', name: 'Pull-ups', muscle: 'Back' },
        { id: 'row', name: 'Barbell Rows', muscle: 'Back' },
        { id: 'face', name: 'Face Pulls', muscle: 'Rear Delts' },
        { id: 'bicep', name: 'Bicep Curls', muscle: 'Biceps' },
        { id: 'hammer', name: 'Hammer Curls', muscle: 'Biceps' }
      ],
      legs: [
        { id: 'squat', name: 'Squats', muscle: 'Quads' },
        { id: 'rdl', name: 'Romanian Deadlifts', muscle: 'Hamstrings' },
        { id: 'legpress', name: 'Leg Press', muscle: 'Quads' },
        { id: 'curl', name: 'Leg Curls', muscle: 'Hamstrings' },
        { id: 'calf', name: 'Calf Raises', muscle: 'Calves' },
        { id: 'lunge', name: 'Lunges', muscle: 'Glutes' }
      ]
    };

    // ==================== HELPER FUNCTIONS ====================
    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function loadState() {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) {
        state = { ...DEFAULT_STATE, ...JSON.parse(saved) };
        checkDailyReset();
      }
    }

    function checkDailyReset() {
      const today = new Date().toISOString().split('T')[0];
      if (state.lastDate !== today) {
        const allCompleted = DAILY_TASKS.every(t => state.completed[t.id]);

        if (!allCompleted) {
          applyPunishment();
        } else {
          state.streak++;
          state.consecutiveMisses = 0;
        }

        state.completed = {};
        state.meals = [];
        state.waterCups = 0;
        state.lastDate = today;
        saveState();
      }
    }

    function applyPunishment() {
      state.consecutiveMisses++;

      if (state.consecutiveMisses === 1) {
        state.xp = Math.max(0, state.xp - 200);
        state.coins = Math.max(0, state.coins - 100);
        Object.keys(state.stats).forEach(key => {
          state.stats[key] = Math.max(1, state.stats[key] - 10);
        });
        state.debuff = {
          type: 'WEAKENED',
          xpPenalty: 0.3,
          endsAt: Date.now() + (24 * 60 * 60 * 1000)
        };
        state.streak = 0;
        showToast('Day missed', 'Time to get back on track', 'warning');
      } else if (state.consecutiveMisses === 2) {
        state.xp = Math.max(0, state.xp - 400);
        state.coins = Math.max(0, state.coins - 200);
        Object.keys(state.stats).forEach(key => {
          state.stats[key] = Math.max(1, state.stats[key] - 20);
        });
        state.debuff = {
          type: 'SEVERELY WEAKENED',
          xpPenalty: 0.6,
          endsAt: Date.now() + (48 * 60 * 60 * 1000)
        };
        showToast('2 days missed', 'Get back to work', 'warning');
      } else {
        if (state.level > 1) state.level--;
        state.xp = Math.max(0, state.xp - 600);
        state.coins = Math.max(0, state.coins - 300);
        Object.keys(state.stats).forEach(key => {
          state.stats[key] = Math.max(1, state.stats[key] - 30);
        });
        state.debuff = {
          type: 'DEVASTATED',
          xpPenalty: 0.9,
          endsAt: Date.now() + (72 * 60 * 60 * 1000)
        };
        showToast('Level dropped', '3+ days missed', 'error');
      }
    }

    function toggleTask(taskId) {
      state.completed[taskId] = !state.completed[taskId];

      if (state.completed[taskId]) {
        const task = DAILY_TASKS.find(t => t.id === taskId);
        let xpGain = task.xp;

        if (state.debuff && Date.now() < state.debuff.endsAt) {
          xpGain = Math.floor(xpGain * (1 - state.debuff.xpPenalty));
        }

        state.xp += xpGain;
        state.coins += task.coins;

        for (const [stat, value] of Object.entries(task.stats)) {
          state.stats[stat] += value;
        }

        const xpNeeded = Math.floor(100 * Math.pow(state.level, 1.2));
        if (state.xp >= xpNeeded) {
          state.level++;
          state.xp -= xpNeeded;
          showToast('Level Up!', `You reached level ${state.level}`, 'success');
        }

        state.taskStreak[taskId] = (state.taskStreak[taskId] || 0) + 1;

        // Log content creation
        if (taskId === 'short' || taskId === 'long') {
          state.contentLog.push({
            date: new Date().toISOString(),
            type: taskId === 'short' ? 'short' : 'long'
          });
        }

        // Log workout
        if (taskId === 'workout') {
          state.workoutLog.push({
            date: new Date().toISOString(),
            type: state.currentDay
          });
        }

        playSound('complete');
        showToast(task.name, `+${xpGain} XP, +${task.coins} coins`, 'success');
      }

      checkMissions();
      saveState();
      render();
    }

    function checkMissions() {
      MISSIONS.forEach(mission => {
        if (!state.missionCompletions[mission.id] || canClaimMission(mission)) {
          if (mission.check()) {
            completeMission(mission);
          }
        }
      });
    }

    function canClaimMission(mission) {
      if (!state.missionCompletions[mission.id]) return true;
      if (mission.cooldown === 0) return false;

      const lastCompletion = state.missionCompletions[mission.id];
      const hoursPassed = (Date.now() - lastCompletion) / (1000 * 60 * 60);
      return hoursPassed >= mission.cooldown;
    }

    function completeMission(mission) {
      let xpGain = mission.xp;
      if (state.debuff && Date.now() < state.debuff.endsAt) {
        xpGain = Math.floor(xpGain * (1 - state.debuff.xpPenalty));
      }

      state.xp += xpGain;
      state.coins += mission.coins;
      state.missionCompletions[mission.id] = Date.now();

      const xpNeeded = Math.floor(100 * Math.pow(state.level, 1.2));
      if (state.xp >= xpNeeded) {
        state.level++;
        state.xp -= xpNeeded;
        showToast('Level Up!', `You reached level ${state.level}`, 'success');
      }

      showToast(`Mission Complete: ${mission.name}`, `+${xpGain} XP, +${mission.coins} coins`, 'success');
      saveState();
      render();
    }

    function addFood(foodId) {
      const food = FOOD_DATABASE.find(f => f.id === foodId);
      if (!food) return;

      state.meals.push({
        ...food,
        time: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })
      });

      saveState();
      render();
      showToast('Food logged', `${food.name} added`, 'success');
    }

    function addWater() {
      state.waterCups++;
      if (state.waterCups >= 8 && !state.completed.water) {
        toggleTask('water');
      }
      saveState();
      render();
    }

    function getTotals() {
      const cal = state.meals.reduce((sum, m) => sum + m.cal, 0);
      const pro = state.meals.reduce((sum, m) => sum + m.pro, 0);
      const carb = state.meals.reduce((sum, m) => sum + m.carb, 0);
      const fat = state.meals.reduce((sum, m) => sum + m.fat, 0);
      return { cal, pro, carb, fat };
    }

    function secondsToMidnight() {
      const now = new Date();
      const options = { timeZone: 'America/New_York', hour12: false };
      const etString = now.toLocaleString('en-US', options);
      const etDate = new Date(etString);

      const midnight = new Date(etDate);
      midnight.setHours(23, 0, 0, 0);

      if (etDate > midnight) {
        midnight.setDate(midnight.getDate() + 1);
      }

      const diff = midnight - etDate;
      return Math.max(0, Math.floor(diff / 1000));
    }

    function formatTime(seconds) {
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      return `${h}h ${m}m`;
    }

    function getTimerClass(seconds) {
      if (seconds < 600) return 'timer-critical';
      if (seconds < 1800) return 'timer-warning';
      return 'timer-good';
    }

    function showToast(title, message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.innerHTML = `
        <div class="font-bold text-sm mb-1">${title}</div>
        <div class="text-xs text-gray-600">${message}</div>
      `;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);

      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification(title, { body: message });
      }
    }

    function requestNotificationPermission() {
      if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission().then(permission => {
          if (permission === 'granted') {
            state.notificationsEnabled = true;
            saveState();
            showToast('Notifications Enabled', 'You\'ll receive daily reminders', 'success');
          }
        });
      }
    }

    function playSound(type) {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain);
      gain.connect(ctx.destination);

      if (type === 'complete') {
        osc.frequency.value = 800;
        gain.gain.setValueAtTime(0.05, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + 0.1);
      }
    }

    function logWeight(weight) {
      state.currentWeight = weight;
      state.weightHistory.push({
        date: new Date().toISOString().split('T')[0],
        weight: weight
      });
      saveState();
      render();
      showToast('Weight Logged', `${weight} lbs recorded`, 'success');
    }

    function switchTab(tab) {
      state.currentTab = tab;
      render();
    }

    // ==================== RENDER ====================
    function render() {
      const app = document.getElementById('app');
      const totals = getTotals();
      const remaining = secondsToMidnight();
      const tasksComplete = DAILY_TASKS.filter(t => state.completed[t.id]).length;
      const tasksTotal = DAILY_TASKS.length;
      const xpNeeded = Math.floor(100 * Math.pow(state.level, 1.2));
      const xpPercent = (state.xp / xpNeeded) * 100;
      const weightLost = state.startWeight - state.currentWeight;
      const weightRemaining = state.currentWeight - state.targetWeight;
      const progressPercent = ((weightLost) / (state.startWeight - state.targetWeight)) * 100;

      // Check calories completion
      if (totals.cal >= state.calorieTarget * 0.9 && totals.cal <= state.calorieTarget * 1.1 && !state.completed.calories) {
        state.completed.calories = true;
        saveState();
      }

      if (state.currentTab === 'home') {
        app.innerHTML = `
          <!-- Status Window Header -->
          <div class="status-window rounded-2xl p-6 mb-4 slide-up">
            <div class="flex justify-between items-start mb-4">
              <div>
                <h1 class="text-3xl font-bold text-gray-800 mb-1">SENSE</h1>
                <p class="text-sm text-gray-500">Self Enhancement System</p>
              </div>
              <div class="level-badge text-lg">
                LV ${state.level}
              </div>
            </div>

            <!-- Weight Progress -->
            <div class="mb-4">
              <div class="flex justify-between text-sm mb-2">
                <span class="font-semibold text-gray-700">Weight Journey</span>
                <span class="text-gray-600">${state.currentWeight} → ${state.targetWeight} lbs</span>
              </div>
              <div class="progress-container">
                <div class="progress-bar" style="width: ${progressPercent}%"></div>
              </div>
              <div class="flex justify-between text-xs text-gray-500 mt-1">
                <span>Lost: ${weightLost} lbs</span>
                <span>Remaining: ${weightRemaining} lbs</span>
              </div>
            </div>

            <!-- XP Progress -->
            <div class="mb-4">
              <div class="flex justify-between text-sm mb-2">
                <span class="font-semibold text-gray-700">Experience</span>
                <span class="text-gray-600">${state.xp} / ${xpNeeded} XP</span>
              </div>
              <div class="progress-container">
                <div class="progress-bar" style="width: ${xpPercent}%"></div>
              </div>
            </div>

            <!-- Stats & Streak -->
            <div class="flex justify-between items-center">
              <div class="flex gap-3">
                <div class="text-center">
                  <div class="text-2xl font-bold" style="color: #fbbf24;">${state.coins}</div>
                  <div class="text-xs text-gray-500">Coins</div>
                </div>
                <div class="text-center">
                  <div class="text-2xl font-bold" style="color: #f97316;">${state.streak}</div>
                  <div class="text-xs text-gray-500">Streak</div>
                </div>
              </div>
              ${state.debuff && Date.now() < state.debuff.endsAt ? `
                <div class="debuff-badge">
                  ${state.debuff.type}
                </div>
              ` : ''}
            </div>
          </div>

          <!-- Countdown Timer -->
          <div class="glass rounded-2xl p-4 mb-4 text-center ${getTimerClass(remaining)}">
            <div class="text-sm font-semibold mb-1 opacity-90">Time Until 11:00 PM</div>
            <div class="text-3xl font-bold mb-2">${formatTime(remaining)}</div>
            <div class="text-sm opacity-90">${tasksComplete}/${tasksTotal} tasks complete</div>
          </div>

          <!-- Daily Tasks -->
          <div class="glass rounded-2xl p-6 mb-4">
            <h2 class="text-xl font-bold text-gray-800 mb-4">📋 Daily Tasks</h2>
            ${DAILY_TASKS.map(task => `
              <div class="task-card ${state.completed[task.id] ? 'completed' : ''}">
                <div class="flex items-center justify-between">
                  <div class="flex-1">
                    <div class="font-semibold text-gray-800 mb-1">${task.name}</div>
                    <div class="text-xs text-gray-500 mb-2">${task.desc}</div>
                    <div class="flex gap-2 text-xs">
                      <span class="text-gray-600">+${task.xp} XP</span>
                      <span class="text-gray-600">+${task.coins} coins</span>
                    </div>
                    ${state.taskStreak[task.id] ? `
                      <div class="text-xs font-semibold mt-1" style="color: #f97316;">
                        🔥 ${state.taskStreak[task.id]} day streak
                      </div>
                    ` : ''}
                  </div>
                  <button
                    onclick="toggleTask('${task.id}')"
                    class="${state.completed[task.id] ? 'btn-complete' : 'btn-primary'}"
                    style="min-width: 80px;"
                  >
                    ${state.completed[task.id] ? '✓ Done' : 'Complete'}
                  </button>
                </div>
              </div>
            `).join('')}
          </div>

          <!-- Notifications -->
          ${!state.notificationsEnabled ? `
            <div class="glass rounded-2xl p-4 mb-4" style="border: 2px solid rgba(251, 191, 36, 0.3);">
              <div class="text-sm font-semibold text-gray-800 mb-2">🔔 Enable Notifications</div>
              <div class="text-xs text-gray-600 mb-3">Get daily reminders to stay on track</div>
              <button onclick="requestNotificationPermission()" class="btn-primary w-full">
                Enable Reminders
              </button>
            </div>
          ` : ''}

          <!-- Tab Navigation -->
          <div class="fixed bottom-0 left-0 right-0 glass-dark p-4 flex gap-2 justify-around">
            <button onclick="switchTab('home')" class="tab active">Home</button>
            <button onclick="switchTab('stats')" class="tab">Stats</button>
            <button onclick="switchTab('missions')" class="tab">Missions</button>
            <button onclick="switchTab('track')" class="tab">Track</button>
          </div>
        `;
      } else if (state.currentTab === 'stats') {
        app.innerHTML = `
          <div class="mb-20">
            <!-- Stats Header -->
            <div class="status-window rounded-2xl p-6 mb-4">
              <h1 class="text-2xl font-bold text-gray-800 mb-2">📊 Your Stats</h1>
              <p class="text-sm text-gray-500">Hover/tap on each stat to learn more</p>
            </div>

            <!-- Stats Grid -->
            <div class="grid grid-cols-2 gap-4 mb-4">
              ${Object.entries(state.stats).map(([key, val]) => {
                const info = STAT_INFO[key];
                return `
                  <div class="glass rounded-2xl p-4 text-center stat-tooltip">
                    <div class="text-4xl font-bold mb-2" style="color: ${info.color};">
                      ${val}
                    </div>
                    <div class="text-sm font-semibold text-gray-700">${info.name}</div>
                    <div class="text-xs text-gray-500 mt-1">${info.desc}</div>
                    <div class="tooltip-text">
                      <strong>${info.name}</strong><br>
                      ${info.desc}<br>
                      <em>Gain from: ${info.gains}</em>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>

            <!-- Stat Explanations -->
            <div class="glass rounded-2xl p-6">
              <h2 class="text-lg font-bold text-gray-800 mb-4">Understanding Stats</h2>
              <div class="space-y-3 text-sm">
                ${Object.entries(STAT_INFO).map(([key, info]) => `
                  <div class="flex items-start gap-3">
                    <div class="w-8 h-8 rounded-lg flex items-center justify-center font-bold text-white"
                         style="background: ${info.color}; min-width: 32px;">
                      ${key.toUpperCase()}
                    </div>
                    <div>
                      <div class="font-semibold text-gray-800">${info.name}</div>
                      <div class="text-xs text-gray-600">${info.desc}</div>
                      <div class="text-xs text-gray-500 mt-1">Gain from: ${info.gains}</div>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>

          <!-- Tab Navigation -->
          <div class="fixed bottom-0 left-0 right-0 glass-dark p-4 flex gap-2 justify-around">
            <button onclick="switchTab('home')" class="tab">Home</button>
            <button onclick="switchTab('stats')" class="tab active">Stats</button>
            <button onclick="switchTab('missions')" class="tab">Missions</button>
            <button onclick="switchTab('track')" class="tab">Track</button>
          </div>
        `;
      } else if (state.currentTab === 'missions') {
        const dailyMissions = MISSIONS.filter(m => m.type === 'daily');
        const weeklyMissions = MISSIONS.filter(m => m.type === 'weekly');
        const epicMissions = MISSIONS.filter(m => m.type === 'epic');

        app.innerHTML = `
          <div class="mb-20">
            <!-- Missions Header -->
            <div class="status-window rounded-2xl p-6 mb-4">
              <h1 class="text-2xl font-bold text-gray-800 mb-2">🎯 Missions</h1>
              <p class="text-sm text-gray-500">Complete missions for bonus rewards</p>
            </div>

            <!-- Daily Missions -->
            <div class="glass rounded-2xl p-6 mb-4">
              <h2 class="text-lg font-bold text-gray-800 mb-4">
                <span class="mission-badge badge-daily">DAILY</span> Daily Missions
              </h2>
              ${dailyMissions.map(mission => {
                const canClaim = mission.check();
                const completed = state.missionCompletions[mission.id];
                const available = canClaimMission(mission);
                return `
                  <div class="task-card ${canClaim && available ? '' : 'opacity-50'}">
                    <div class="font-semibold text-gray-800 mb-1">${mission.name}</div>
                    <div class="text-xs text-gray-600 mb-2">${mission.desc}</div>
                    <div class="flex justify-between items-center">
                      <div class="text-xs text-gray-600">+${mission.xp} XP, +${mission.coins} coins</div>
                      <div class="text-xs font-semibold ${canClaim && available ? 'text-green-600' : 'text-gray-400'}">
                        ${canClaim && available ? '✓ Complete' : completed ? '⏱️ On cooldown' : '○ Incomplete'}
                      </div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>

            <!-- Weekly Missions -->
            <div class="glass rounded-2xl p-6 mb-4">
              <h2 class="text-lg font-bold text-gray-800 mb-4">
                <span class="mission-badge badge-weekly">WEEKLY</span> Weekly Missions
              </h2>
              ${weeklyMissions.map(mission => {
                const canClaim = mission.check();
                const completed = state.missionCompletions[mission.id];
                const available = canClaimMission(mission);
                return `
                  <div class="task-card ${canClaim && available ? '' : 'opacity-50'}">
                    <div class="font-semibold text-gray-800 mb-1">${mission.name}</div>
                    <div class="text-xs text-gray-600 mb-2">${mission.desc}</div>
                    <div class="flex justify-between items-center">
                      <div class="text-xs text-gray-600">+${mission.xp} XP, +${mission.coins} coins</div>
                      <div class="text-xs font-semibold ${canClaim && available ? 'text-green-600' : 'text-gray-400'}">
                        ${canClaim && available ? '✓ Complete' : completed ? '⏱️ On cooldown' : '○ Incomplete'}
                      </div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>

            <!-- Epic Missions -->
            <div class="glass rounded-2xl p-6 mb-4">
              <h2 class="text-lg font-bold text-gray-800 mb-4">
                <span class="mission-badge badge-epic">EPIC</span> Epic Missions
              </h2>
              ${epicMissions.map(mission => {
                const canClaim = mission.check();
                const completed = state.missionCompletions[mission.id];
                return `
                  <div class="task-card ${canClaim ? 'border-2 border-purple-400' : 'opacity-50'}">
                    <div class="font-semibold text-gray-800 mb-1">${mission.name}</div>
                    <div class="text-xs text-gray-600 mb-2">${mission.desc}</div>
                    <div class="flex justify-between items-center">
                      <div class="text-xs text-gray-600">+${mission.xp} XP, +${mission.coins} coins</div>
                      <div class="text-xs font-semibold ${canClaim ? 'text-purple-600' : 'text-gray-400'}">
                        ${canClaim ? '✓ Complete!' : completed ? '✅ Claimed' : '○ Incomplete'}
                      </div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>

          <!-- Tab Navigation -->
          <div class="fixed bottom-0 left-0 right-0 glass-dark p-4 flex gap-2 justify-around">
            <button onclick="switchTab('home')" class="tab">Home</button>
            <button onclick="switchTab('stats')" class="tab">Stats</button>
            <button onclick="switchTab('missions')" class="tab active">Missions</button>
            <button onclick="switchTab('track')" class="tab">Track</button>
          </div>
        `;
      } else if (state.currentTab === 'track') {
        app.innerHTML = `
          <div class="mb-20">
            <!-- Nutrition Tracker -->
            <div class="glass rounded-2xl p-6 mb-4">
              <h2 class="text-xl font-bold text-gray-800 mb-4">🍽️ Nutrition</h2>

              <!-- Calorie Progress -->
              <div class="mb-4">
                <div class="flex justify-between text-sm mb-2">
                  <span class="font-semibold text-gray-700">Calories</span>
                  <span class="text-gray-600">${totals.cal} / ${state.calorieTarget}</span>
                </div>
                <div class="progress-container">
                  <div class="progress-bar" style="width: ${Math.min(100, (totals.cal / state.calorieTarget) * 100)}%"></div>
                </div>
              </div>

              <!-- Macros -->
              <div class="grid grid-cols-3 gap-3 mb-4">
                <div class="text-center">
                  <div class="text-2xl font-bold" style="color: #f97316;">${totals.pro}g</div>
                  <div class="text-xs text-gray-500">Protein</div>
                  <div class="text-xs text-gray-400">${state.proteinTarget}g goal</div>
                </div>
                <div class="text-center">
                  <div class="text-2xl font-bold" style="color: #22c55e;">${totals.carb}g</div>
                  <div class="text-xs text-gray-500">Carbs</div>
                  <div class="text-xs text-gray-400">${state.carbTarget}g goal</div>
                </div>
                <div class="text-center">
                  <div class="text-2xl font-bold" style="color: #eab308;">${totals.fat}g</div>
                  <div class="text-xs text-gray-500">Fats</div>
                  <div class="text-xs text-gray-400">${state.fatTarget}g goal</div>
                </div>
              </div>

              <!-- Quick Add -->
              <div class="mb-4">
                <div class="text-sm font-semibold text-gray-700 mb-2">Quick Add</div>
                <div class="grid grid-cols-3 gap-2">
                  ${FOOD_DATABASE.slice(0, 6).map(food => `
                    <button onclick="addFood('${food.id}')" class="task-card p-2 text-xs font-semibold hover:scale-105 transition-transform">
                      ${food.name}
                    </button>
                  `).join('')}
                </div>
              </div>

              <!-- Recent Meals -->
              ${state.meals.length > 0 ? `
                <div>
                  <div class="text-sm font-semibold text-gray-700 mb-2">Recent Meals</div>
                  <div class="space-y-1">
                    ${state.meals.slice(-5).map(m => `
                      <div class="task-card p-2 flex justify-between text-xs">
                        <span>${m.name} (${m.serving})</span>
                        <span class="text-gray-500">${m.cal} cal</span>
                      </div>
                    `).join('')}
                  </div>
                </div>
              ` : ''}
            </div>

            <!-- Water Tracker -->
            <div class="glass rounded-2xl p-6 mb-4">
              <h2 class="text-xl font-bold text-gray-800 mb-4">💧 Water</h2>
              <div class="flex gap-2 mb-4 justify-center">
                ${Array(8).fill(0).map((_, i) => `
                  <div class="w-10 h-10 rounded-full ${i < state.waterCups ? 'bg-blue-400' : 'bg-gray-200'}
                       flex items-center justify-center text-white font-bold transition-all">
                    ${i < state.waterCups ? '✓' : ''}
                  </div>
                `).join('')}
              </div>
              <button onclick="addWater()" class="btn-primary w-full">
                + Add Cup (${state.waterCups}/8)
              </button>
            </div>

            <!-- Workout Logger -->
            <div class="glass rounded-2xl p-6 mb-4">
              <h2 class="text-xl font-bold text-gray-800 mb-4">💪 Today's Workout</h2>

              <div class="flex gap-2 mb-4">
                ${['push', 'pull', 'legs'].map(day => `
                  <button
                    onclick="state.currentDay='${day}'; saveState(); render();"
                    class="${state.currentDay === day ? 'btn-primary' : 'task-card'} flex-1 py-2 text-sm font-bold"
                  >
                    ${day.toUpperCase()}
                  </button>
                `).join('')}
              </div>

              <div class="space-y-1">
                ${EXERCISES[state.currentDay].map(ex => `
                  <div class="task-card p-2 flex justify-between text-sm">
                    <span>${ex.name}</span>
                    <span class="text-gray-500">${ex.muscle}</span>
                  </div>
                `).join('')}
              </div>
            </div>

            <!-- Weight Logger -->
            <div class="glass rounded-2xl p-6 mb-4">
              <h2 class="text-xl font-bold text-gray-800 mb-4">⚖️ Log Weight</h2>
              <div class="flex gap-2">
                <input
                  type="number"
                  id="weightInput"
                  placeholder="${state.currentWeight}"
                  class="flex-1 glass rounded-lg px-4 py-3 text-gray-800 font-semibold"
                  step="0.1"
                />
                <button
                  onclick="const w = parseFloat(document.getElementById('weightInput').value); if(w) logWeight(w);"
                  class="btn-primary px-6"
                >
                  LOG
                </button>
              </div>
            </div>
          </div>

          <!-- Tab Navigation -->
          <div class="fixed bottom-0 left-0 right-0 glass-dark p-4 flex gap-2 justify-around">
            <button onclick="switchTab('home')" class="tab">Home</button>
            <button onclick="switchTab('stats')" class="tab">Stats</button>
            <button onclick="switchTab('missions')" class="tab">Missions</button>
            <button onclick="switchTab('track')" class="tab active">Track</button>
          </div>
        `;
      }
    }

    // ==================== INIT ====================
    loadState();
    render();

    setInterval(() => {
      render();
    }, 1000);

    // Make functions global
    window.toggleTask = toggleTask;
    window.addFood = addFood;
    window.addWater = addWater;
    window.requestNotificationPermission = requestNotificationPermission;
    window.logWeight = logWeight;
    window.switchTab = switchTab;
    window.state = state;
    window.saveState = saveState;
    window.render = render;
  </script>
</body>
</html>
