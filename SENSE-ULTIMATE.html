<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SENSE - Your Life RPG</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

    :root {
      --darkest: #000000;
      --dark: #0a0a0a;
      --medium: #0f1419;
      --cyan: #00D9FF;
      --cyan-bright: #00FFFF;
      --blue: #0288D1;
      --orange: #FF6C00;
      --orange-bright: #FF9100;
      --electric-blue: #1FB4FF;
      --glow-cyan: rgba(0, 217, 255, 0.5);
      --glow-orange: rgba(255, 108, 0, 0.5);
    }

    * {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    body {
      background: linear-gradient(180deg, #000000 0%, #0a0a0a 50%, #0f1419 100%);
      min-height: 100vh;
    }

    .glass {
      background: rgba(10, 10, 10, 0.95);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(0, 217, 255, 0.3);
      box-shadow: 0 0 20px rgba(0, 217, 255, 0.15), 0 4px 16px rgba(0, 0, 0, 0.6);
    }

    .glass-dark {
      background: rgba(0, 0, 0, 0.98);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(0, 217, 255, 0.2);
      box-shadow: 0 0 15px rgba(0, 217, 255, 0.1);
    }

    .status-window {
      background: rgba(10, 10, 10, 0.98);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(0, 217, 255, 0.5);
      box-shadow: 0 0 30px rgba(0, 217, 255, 0.3), 0 4px 16px rgba(0, 0, 0, 0.6);
    }

    .text-cream { color: #00FFFF; }
    .text-medium { color: #1FB4FF; }
    .text-dark { color: #FFFFFF; }
    .text-gold { color: #00D9FF; }
    .text-purple { color: #FF9100; }
    .text-cyan { color: #00D9FF; }
    .text-white { color: #FFFFFF; }
    .bg-cream { background: #0f1419; }
    .bg-medium { background: #0f1419; }
    .bg-dark { background: #0a0a0a; }
    .bg-gold { background: #00D9FF; }
    .border-medium { border-color: #00D9FF; }
    .border-cream { border-color: #00FFFF; }
    .border-gold { border-color: #00D9FF; }

    .progress-bar {
      background: linear-gradient(90deg, #00D9FF 0%, #1FB4FF 50%, #0288D1 100%);
      height: 8px;
      border-radius: 4px;
      transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 0 10px rgba(0, 217, 255, 0.6);
    }

    .progress-container {
      background: rgba(0, 0, 0, 0.8);
      border-radius: 4px;
      overflow: hidden;
      border: 1px solid rgba(0, 217, 255, 0.2);
    }

    .btn-primary {
      background: linear-gradient(135deg, #00D9FF 0%, #0288D1 100%);
      color: #000000;
      font-weight: 700;
      border: 1px solid #00FFFF;
      border-radius: 8px;
      padding: 12px 24px;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 0 15px rgba(0, 217, 255, 0.5), inset 0 0 10px rgba(255, 255, 255, 0.2);
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #00FFFF 0%, #1FB4FF 100%);
      transform: translateY(-1px);
      box-shadow: 0 0 25px rgba(0, 217, 255, 0.8), inset 0 0 15px rgba(255, 255, 255, 0.3);
    }

    .btn-success {
      background: rgba(0, 0, 0, 0.8);
      color: #00FFFF;
      border: 1px solid rgba(0, 217, 255, 0.5);
      font-weight: 700;
      border-radius: 8px;
      padding: 12px 24px;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 0 10px rgba(0, 217, 255, 0.2);
    }

    .btn-success:hover {
      background: rgba(0, 217, 255, 0.1);
      border-color: rgba(0, 255, 255, 0.8);
      box-shadow: 0 0 15px rgba(0, 217, 255, 0.4);
    }

    .btn-reward {
      background: linear-gradient(135deg, #FF6C00 0%, #FF9100 100%);
      color: #000000;
      font-weight: 700;
      border: 1px solid #FF9100;
      box-shadow: 0 0 15px rgba(255, 108, 0, 0.5);
    }

    .btn-reward:hover {
      box-shadow: 0 0 25px rgba(255, 108, 0, 0.8);
    }

    .task-card {
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      border: 1px solid rgba(0, 217, 255, 0.3);
      transition: all 0.2s ease;
      box-shadow: 0 0 10px rgba(0, 217, 255, 0.1);
    }

    .task-card:hover {
      background: rgba(15, 20, 25, 0.9);
      border-color: rgba(0, 217, 255, 0.6);
      box-shadow: 0 0 20px rgba(0, 217, 255, 0.3);
    }

    .task-card.completed {
      background: rgba(0, 217, 255, 0.1);
      border: 1px solid rgba(0, 217, 255, 0.8);
      box-shadow: 0 0 25px rgba(0, 217, 255, 0.4);
    }

    .mission-badge {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .badge-extra {
      background: rgba(0, 217, 255, 0.2);
      color: #00FFFF;
      border: 1px solid rgba(0, 217, 255, 0.6);
      box-shadow: 0 0 10px rgba(0, 217, 255, 0.3);
    }

    .badge-weekly {
      background: rgba(31, 180, 255, 0.2);
      color: #1FB4FF;
      border: 1px solid rgba(31, 180, 255, 0.6);
      box-shadow: 0 0 10px rgba(31, 180, 255, 0.3);
    }

    .badge-epic {
      background: rgba(255, 108, 0, 0.2);
      color: #FF9100;
      border: 1px solid rgba(255, 108, 0, 0.6);
      box-shadow: 0 0 10px rgba(255, 108, 0, 0.3);
    }

    .timer-urgent {
      background: rgba(255, 108, 0, 0.2);
      border: 1px solid rgba(255, 108, 0, 0.6);
      color: #FF9100;
      animation: pulse 2s infinite;
      box-shadow: 0 0 15px rgba(255, 108, 0, 0.4);
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 1;
        transform: scale(1);
      }
      50% {
        opacity: 0.9;
        transform: scale(1.01);
      }
    }

    .level-badge {
      background: linear-gradient(135deg, #00D9FF 0%, #0288D1 100%);
      color: #000000;
      padding: 6px 16px;
      border-radius: 6px;
      font-weight: 700;
      display: inline-block;
      border: 1px solid #00FFFF;
      box-shadow: 0 0 15px rgba(0, 217, 255, 0.6);
    }

    /* Streak Badge - Tron Style */
    .streak-badge {
      background: rgba(0, 0, 0, 0.9);
      padding: 12px 20px;
      border-radius: 8px;
      display: inline-flex;
      align-items: center;
      gap: 12px;
      border: 1px solid rgba(255, 108, 0, 0.8);
      box-shadow: 0 0 20px rgba(255, 108, 0, 0.5);
    }

    .streak-number {
      font-size: 24px;
      font-weight: 700;
      color: #FF9100;
      text-shadow: 0 0 10px rgba(255, 108, 0, 0.8);
    }

    .streak-label {
      font-size: 14px;
      font-weight: 600;
      color: #00FFFF;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Rank Badge - Tron Style */
    .rank-badge {
      padding: 8px 16px;
      border-radius: 8px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
      border: 2px solid;
      box-shadow: 0 0 15px;
    }

    .rank-icon {
      font-size: 20px;
    }

    .rank-name {
      font-size: 14px;
    }

    .tab {
      padding: 8px 12px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      background: transparent;
      color: #1FB4FF;
      font-size: 12px;
      border: 1px solid transparent;
    }

    .tab:hover {
      color: #00FFFF;
      border-color: rgba(0, 217, 255, 0.3);
      box-shadow: 0 0 10px rgba(0, 217, 255, 0.2);
    }

    .tab.active {
      background: rgba(0, 217, 255, 0.2);
      color: #00FFFF;
      border: 1px solid rgba(0, 217, 255, 0.6);
      box-shadow: 0 0 15px rgba(0, 217, 255, 0.4);
    }

    .reward-item {
      background: rgba(0, 0, 0, 0.9);
      border: 1px solid rgba(0, 217, 255, 0.3);
      border-radius: 12px;
      padding: 16px;
      transition: all 0.2s ease;
      box-shadow: 0 0 10px rgba(0, 217, 255, 0.1);
    }

    .reward-item:hover {
      background: rgba(15, 20, 25, 0.9);
      border-color: rgba(255, 108, 0, 0.5);
      box-shadow: 0 0 20px rgba(255, 108, 0, 0.3);
    }

    .reward-item.owned {
      opacity: 0.6;
      border-color: rgba(0, 217, 255, 0.5);
      box-shadow: 0 0 15px rgba(0, 217, 255, 0.2);
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.98);
      backdrop-filter: blur(20px);
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: 0 0 30px rgba(0, 217, 255, 0.6), 0 8px 32px rgba(0, 0, 0, 0.8);
      border: 1px solid rgba(0, 217, 255, 0.8);
      z-index: 9999;
      animation: slideInRight 0.4s ease-out;
      max-width: 300px;
    }

    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(100px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .workout-card {
      background: rgba(0, 0, 0, 0.95);
      border: 1px solid rgba(0, 217, 255, 0.3);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 12px;
      transition: all 0.2s ease;
      box-shadow: 0 0 10px rgba(0, 217, 255, 0.1);
    }

    .workout-card:hover {
      background: rgba(15, 20, 25, 0.95);
      border-color: rgba(0, 217, 255, 0.6);
      box-shadow: 0 0 20px rgba(0, 217, 255, 0.3);
    }

    .workout-img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 8px;
      background: rgba(0, 0, 0, 0.8);
      border: 1px solid rgba(0, 217, 255, 0.2);
    }

    /* Photo Modal */
    .photo-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: 20px;
    }

    .photo-modal-content {
      background: rgba(0, 0, 0, 0.98);
      border-radius: 20px;
      padding: 24px;
      max-width: 400px;
      width: 100%;
      box-shadow: 0 0 40px rgba(0, 217, 255, 0.6), 0 20px 60px rgba(0, 0, 0, 0.9);
      border: 2px solid rgba(0, 217, 255, 0.8);
    }

    .photo-preview {
      width: 100%;
      max-height: 300px;
      object-fit: cover;
      border-radius: 12px;
      margin: 16px 0;
      background: rgba(0, 0, 0, 0.8);
      border: 1px solid rgba(0, 217, 255, 0.4);
      box-shadow: 0 0 15px rgba(0, 217, 255, 0.2);
    }

    .camera-input {
      display: none;
    }

    /* Calendar View */
    .calendar-day {
      background: rgba(0, 0, 0, 0.95);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 12px;
      border: 1px solid rgba(0, 217, 255, 0.3);
      box-shadow: 0 0 10px rgba(0, 217, 255, 0.1);
    }

    .proof-image {
      width: 100%;
      height: 80px;
      object-fit: cover;
      border-radius: 8px;
      margin-top: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid rgba(0, 217, 255, 0.3);
      box-shadow: 0 0 5px rgba(0, 217, 255, 0.1);
    }

    .proof-image:hover {
      transform: scale(1.05);
      border-color: rgba(0, 217, 255, 0.8);
      box-shadow: 0 0 20px rgba(0, 217, 255, 0.4);
    }

    .task-badge {
      display: inline-block;
      background: rgba(0, 217, 255, 0.2);
      color: #00FFFF;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      margin-right: 6px;
      margin-bottom: 6px;
      border: 1px solid rgba(0, 217, 255, 0.4);
      box-shadow: 0 0 5px rgba(0, 217, 255, 0.2);
    }
  </style>
</head>
<body class="p-4 pb-24">
  <div id="app" class="max-w-md mx-auto"></div>

  <script>
    const STORAGE_KEY = 'sense_ultimate_v5';
    const DEFAULT_STATE = {
      currentWeight: 260,
      targetWeight: 175,
      startWeight: 260,
      weightHistory: [],
      lastWeighIn: null,

      level: 1,
      xp: 0,
      coins: 0,
      streak: 0,
      consecutiveMisses: 0,

      // Only 4 stats, all start at 0
      stats: {
        str: 0,  // Strength
        end: 0,  // Endurance
        int: 0,  // Intelligence
        dis: 0   // Discipline
      },

      debuff: null,
      completed: {},
      taskStreak: {},
      completionHistory: [],  // Store all task completions with photos and dates

      // Calorie tracking
      manualCalories: 0,
      manualProtein: 0,
      manualCarbs: 0,
      manualFats: 0,
      calorieTarget: 2100,

      currentDay: 'push',
      shortFormCount: 0,

      extraMissions: {},
      rewards: [],
      inventory: [],  // Store purchased items here
      lastDate: new Date().toISOString().split('T')[0],
      currentTab: 'home'
    };

    let state = { ...DEFAULT_STATE };

    // Daily tasks - NO long-form content, short-form is 2 videos
    const DAILY_TASKS = [
      {
        id: 'bible',
        name: 'üìñ Read Bible',
        desc: '15 minutes',
        xp: 50,
        coins: 20,
        stats: {dis: 5, int: 3}
      },
      {
        id: 'workout',
        name: 'üí™ Complete Workout',
        desc: 'Push/Pull/Legs',
        xp: 100,
        coins: 50,
        stats: {str: 10, end: 10, dis: 5}
      },
      {
        id: 'ai',
        name: 'ü§ñ Learn AI',
        desc: '30-60 min',
        xp: 75,
        coins: 30,
        stats: {int: 10, dis: 3}
      },
      {
        id: 'short',
        name: 'üì± Short-Form (2 videos)',
        desc: 'Create 2 short videos',
        xp: 80,
        coins: 50,
        stats: {int: 5, dis: 5}
      },
      {
        id: 'calories',
        name: 'üçΩÔ∏è Track Calories',
        desc: 'Log your food',
        xp: 40,
        coins: 25,
        stats: {dis: 5}
      }
    ];

    // Extra missions focused on main goals
    const EXTRA_MISSIONS = [
      // Extra Daily
      {
        id: 'second_workout',
        name: 'Double Training',
        desc: 'Complete a second workout session',
        type: 'extra',
        xp: 150,
        coins: 75,
        stats: {str: 10, end: 10},
        cooldown: 24
      },
      {
        id: 'extra_bible',
        name: 'Deep Study',
        desc: 'Read an additional Bible chapter',
        type: 'extra',
        xp: 50,
        coins: 25,
        stats: {dis: 5, int: 3},
        cooldown: 24
      },
      {
        id: 'long_form',
        name: 'Long-Form Content',
        desc: 'Create YouTube/Blog content',
        type: 'extra',
        xp: 120,
        coins: 80,
        stats: {int: 10, dis: 5},
        cooldown: 24
      },
      {
        id: 'ai_project',
        name: 'AI Project',
        desc: 'Build something with AI',
        type: 'extra',
        xp: 150,
        coins: 100,
        stats: {int: 15, dis: 10},
        cooldown: 24
      },

      // Weekly
      {
        id: 'perfect_week',
        name: 'Perfect Week',
        desc: 'Complete all daily tasks for 7 days',
        type: 'weekly',
        xp: 500,
        coins: 250,
        stats: {dis: 20},
        cooldown: 168
      },
      {
        id: 'content_week',
        name: 'Content Streak',
        desc: 'Create content 7 days straight',
        type: 'weekly',
        xp: 400,
        coins: 200,
        stats: {int: 15, dis: 10},
        cooldown: 168
      },

      // Epic
      {
        id: 'weight_10',
        name: 'First 10 Pounds',
        desc: 'Lose 10 lbs (260 ‚Üí 250)',
        type: 'epic',
        xp: 1000,
        coins: 500,
        stats: {str: 15, end: 15, dis: 20},
        cooldown: 0
      },
      {
        id: 'level_10',
        name: 'Level 10',
        desc: 'Reach Level 10',
        type: 'epic',
        xp: 1500,
        coins: 750,
        stats: {dis: 25},
        cooldown: 0
      },
      {
        id: 'month_streak',
        name: '30-Day Streak',
        desc: 'Maintain 30 days',
        type: 'epic',
        xp: 2000,
        coins: 1000,
        stats: {dis: 30},
        cooldown: 0
      }
    ];

    // Lifestyle rewards in store - INCREASED PRICES
    const REWARDS = [
      {
        id: 'day_off',
        name: 'Day Off Pass',
        desc: 'Take 1 day off without penalties (protects streak)',
        price: 1500,
        type: 'consumable',
        icon: 'üèñÔ∏è'
      },
      {
        id: 'cheat_meal',
        name: 'Cheat Meal',
        desc: 'Enjoy a guilt-free cheat meal',
        price: 800,
        type: 'consumable',
        icon: 'üçï'
      },
      {
        id: 'movie_night',
        name: 'Movie Night',
        desc: 'Relax with a movie night',
        price: 600,
        type: 'consumable',
        icon: 'üé¨'
      },
      {
        id: 'gaming_session',
        name: '2-Hour Gaming',
        desc: 'Guilt-free gaming session',
        price: 700,
        type: 'consumable',
        icon: 'üéÆ'
      },
      {
        id: 'sleep_in',
        name: 'Sleep In',
        desc: 'Skip morning routine, sleep in',
        price: 400,
        type: 'consumable',
        icon: 'üò¥'
      },
      {
        id: 'takeout',
        name: 'Takeout Meal',
        desc: 'Order your favorite food',
        price: 600,
        type: 'consumable',
        icon: 'ü•°'
      },
      {
        id: 'social_media',
        name: 'Social Media Hour',
        desc: '1 hour of mindless scrolling',
        price: 300,
        type: 'consumable',
        icon: 'üì±'
      },
      {
        id: 'rest_day',
        name: 'Rest Day',
        desc: 'Skip workout, full recovery day',
        price: 1200,
        type: 'consumable',
        icon: 'üõãÔ∏è'
      }
    ];

    // Workout knowledge base
    const WORKOUT_KB = {
      push: [
        {
          name: 'Bench Press',
          muscle: 'Chest',
          desc: 'Lie on bench, lower bar to chest, press up',
          tips: 'Keep feet flat, arch lower back slightly',
          img: 'https://images.unsplash.com/photo-1571019614242-c5c5dee9f50b?w=400&h=300&fit=crop'
        },
        {
          name: 'Overhead Press',
          muscle: 'Shoulders',
          desc: 'Press barbell from shoulders overhead',
          tips: 'Keep core tight, don\'t lean back',
          img: 'https://images.unsplash.com/photo-1534258936925-c58bed479fcb?w=400&h=300&fit=crop'
        },
        {
          name: 'Incline Dumbbell Press',
          muscle: 'Upper Chest',
          desc: 'Press dumbbells on incline bench',
          tips: 'Set bench to 30-45 degrees',
          img: 'https://images.unsplash.com/photo-1541534741688-6078c6bfb5c5?w=400&h=300&fit=crop'
        },
        {
          name: 'Lateral Raises',
          muscle: 'Shoulders',
          desc: 'Raise dumbbells to sides',
          tips: 'Slight bend in elbows, control the weight',
          img: 'https://images.unsplash.com/photo-1581009146145-b5ef050c2e1e?w=400&h=300&fit=crop'
        },
        {
          name: 'Tricep Dips',
          muscle: 'Triceps',
          desc: 'Lower body between parallel bars',
          tips: 'Lean forward slightly, full range of motion',
          img: 'https://images.unsplash.com/photo-1597347316833-f0b3d5d0e622?w=400&h=300&fit=crop'
        }
      ],
      pull: [
        {
          name: 'Deadlifts',
          muscle: 'Back/Hamstrings',
          desc: 'Lift barbell from ground to standing',
          tips: 'Keep back straight, drive through heels',
          img: 'https://images.unsplash.com/photo-1534438327276-14e5300c3a48?w=400&h=300&fit=crop'
        },
        {
          name: 'Pull-ups',
          muscle: 'Back/Lats',
          desc: 'Pull body up to bar',
          tips: 'Full hang, pull chin over bar',
          img: 'https://images.unsplash.com/photo-1598632640487-6ea4a4e8b963?w=400&h=300&fit=crop'
        },
        {
          name: 'Barbell Rows',
          muscle: 'Back',
          desc: 'Row barbell to lower chest',
          tips: 'Hinge at hips, keep back flat',
          img: 'https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=400&h=300&fit=crop'
        },
        {
          name: 'Face Pulls',
          muscle: 'Rear Delts',
          desc: 'Pull rope to face level',
          tips: 'External rotation at end, squeeze',
          img: 'https://images.unsplash.com/photo-1574680088814-a04e3e4e6e9a?w=400&h=300&fit=crop'
        },
        {
          name: 'Bicep Curls',
          muscle: 'Biceps',
          desc: 'Curl weight to shoulders',
          tips: 'Don\'t swing, control the negative',
          img: 'https://images.unsplash.com/photo-1581009146145-b5ef050c2e1e?w=400&h=300&fit=crop'
        }
      ],
      legs: [
        {
          name: 'Squats',
          muscle: 'Quads/Glutes',
          desc: 'Lower hips below parallel',
          tips: 'Knees track over toes, chest up',
          img: 'https://images.unsplash.com/photo-1574680096145-d05b474e2155?w=400&h=300&fit=crop'
        },
        {
          name: 'Romanian Deadlifts',
          muscle: 'Hamstrings',
          desc: 'Hinge at hips, lower bar to shins',
          tips: 'Slight knee bend, feel hamstring stretch',
          img: 'https://images.unsplash.com/photo-1517836357463-d25dfeac3438?w=400&h=300&fit=crop'
        },
        {
          name: 'Leg Press',
          muscle: 'Quads',
          desc: 'Press weight with legs',
          tips: 'Feet shoulder width, full range',
          img: 'https://images.unsplash.com/photo-1434682881908-b43d0467b798?w=400&h=300&fit=crop'
        },
        {
          name: 'Leg Curls',
          muscle: 'Hamstrings',
          desc: 'Curl weight to glutes',
          tips: 'Control the weight, squeeze at top',
          img: 'https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=400&h=300&fit=crop'
        },
        {
          name: 'Calf Raises',
          muscle: 'Calves',
          desc: 'Rise up on toes',
          tips: 'Full stretch, pause at top',
          img: 'https://images.unsplash.com/photo-1571902943202-507ec2618e8f?w=400&h=300&fit=crop'
        }
      ]
    };

    const STAT_INFO = {
      str: {
        name: 'Strength',
        desc: 'Physical power',
        color: '#F6554D',
        gains: 'Workouts, lifting'
      },
      end: {
        name: 'Endurance',
        desc: 'Stamina',
        color: '#4A5F8C',
        gains: 'Workouts, consistency'
      },
      int: {
        name: 'Intelligence',
        desc: 'Knowledge',
        color: '#FABB5A',
        gains: 'AI learning, Bible, content'
      },
      dis: {
        name: 'Discipline',
        desc: 'Self-control',
        color: '#F7F1EA',
        gains: 'All tasks, streaks'
      }
    };

    // Rank system based on total stats
    const RANKS = [
      {
        name: 'Unranked',
        icon: '‚ö™',
        minStats: 0,
        color: '#8B8B8B',
        gradient: 'linear-gradient(135deg, #6B6B6B 0%, #8B8B8B 100%)'
      },
      {
        name: 'Bronze',
        icon: 'ü•â',
        minStats: 50,
        color: '#CD7F32',
        gradient: 'linear-gradient(135deg, #CD7F32 0%, #E8A87C 100%)'
      },
      {
        name: 'Silver',
        icon: 'ü•à',
        minStats: 150,
        color: '#C0C0C0',
        gradient: 'linear-gradient(135deg, #A8A8A8 0%, #E8E8E8 100%)'
      },
      {
        name: 'Gold',
        icon: 'ü•á',
        minStats: 300,
        color: '#FFD700',
        gradient: 'linear-gradient(135deg, #FFD700 0%, #FFF176 100%)'
      },
      {
        name: 'Platinum',
        icon: 'üíé',
        minStats: 500,
        color: '#E5E4E2',
        gradient: 'linear-gradient(135deg, #B4C6DA 0%, #E5E4E2 100%)'
      },
      {
        name: 'Diamond',
        icon: 'üí†',
        minStats: 800,
        color: '#B9F2FF',
        gradient: 'linear-gradient(135deg, #4FC3F7 0%, #B9F2FF 100%)'
      },
      {
        name: 'Master',
        icon: 'üëë',
        minStats: 1200,
        color: '#9C27B0',
        gradient: 'linear-gradient(135deg, #7B1FA2 0%, #BA68C8 100%)'
      },
      {
        name: 'Grandmaster',
        icon: '‚ö°',
        minStats: 1800,
        color: '#FF6F00',
        gradient: 'linear-gradient(135deg, #F57C00 0%, #FFB74D 100%)'
      },
      {
        name: 'Legendary',
        icon: 'üî•',
        minStats: 2500,
        color: '#FF1744',
        gradient: 'linear-gradient(135deg, #D50000 0%, #FF5252 100%)'
      }
    ];

    // Calculate current rank based on total stats
    function getCurrentRank() {
      const totalStats = Object.values(state.stats).reduce((sum, val) => sum + val, 0);
      let currentRank = RANKS[0];

      for (const rank of RANKS) {
        if (totalStats >= rank.minStats) {
          currentRank = rank;
        } else {
          break;
        }
      }

      return { rank: currentRank, totalStats };
    }

    function getNextRank() {
      const { rank: currentRank, totalStats } = getCurrentRank();
      const currentIndex = RANKS.findIndex(r => r.name === currentRank.name);

      if (currentIndex < RANKS.length - 1) {
        const nextRank = RANKS[currentIndex + 1];
        const progress = ((totalStats - currentRank.minStats) / (nextRank.minStats - currentRank.minStats)) * 100;
        return { nextRank, progress: Math.min(100, Math.max(0, progress)), statsNeeded: nextRank.minStats - totalStats };
      }

      return { nextRank: null, progress: 100, statsNeeded: 0 };
    }

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function loadState() {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) {
        state = { ...DEFAULT_STATE, ...JSON.parse(saved) };
        checkDailyReset();
      }
    }

    function checkDailyReset() {
      const today = new Date().toISOString().split('T')[0];
      if (state.lastDate !== today) {
        const allCompleted = DAILY_TASKS.every(t => state.completed[t.id]);

        if (!allCompleted) {
          // Check for day off pass
          const hasPass = state.rewards.some(r => r.id === 'day_off' && !r.used);
          if (hasPass) {
            const pass = state.rewards.find(r => r.id === 'day_off' && !r.used);
            pass.used = true;
            showToast('Day Off Pass Used', 'Your streak is protected!', 'success');
          } else {
            applyPunishment();
          }
        } else {
          state.streak++;
          state.consecutiveMisses = 0;
        }

        state.completed = {};
        state.shortFormCount = 0;
        state.manualCalories = 0;
        state.manualProtein = 0;
        state.manualCarbs = 0;
        state.manualFats = 0;
        state.lastDate = today;
        saveState();
      }
    }

    function applyPunishment() {
      state.consecutiveMisses++;
      state.streak = 0;

      if (state.consecutiveMisses === 1) {
        state.xp = Math.max(0, state.xp - 200);
        state.coins = Math.max(0, state.coins - 100);
        Object.keys(state.stats).forEach(key => {
          state.stats[key] = Math.max(0, state.stats[key] - 10);
        });
      } else if (state.consecutiveMisses === 2) {
        state.xp = Math.max(0, state.xp - 400);
        state.coins = Math.max(0, state.coins - 200);
        Object.keys(state.stats).forEach(key => {
          state.stats[key] = Math.max(0, state.stats[key] - 20);
        });
      } else {
        if (state.level > 1) state.level--;
        state.xp = Math.max(0, state.xp - 600);
        state.coins = Math.max(0, state.coins - 300);
        Object.keys(state.stats).forEach(key => {
          state.stats[key] = Math.max(0, state.stats[key] - 30);
        });
      }
    }

    function toggleTask(taskId) {
      // If marking as complete, require photo proof
      if (!state.completed[taskId]) {
        showPhotoModal(taskId, 'daily');
      } else {
        // Uncompleting - just toggle and remove from history
        state.completed[taskId] = false;
        // Remove from today's history
        const today = new Date().toISOString().split('T')[0];
        state.completionHistory = state.completionHistory.filter(
          h => !(h.date === today && h.taskId === taskId && h.taskType === 'daily')
        );
        saveState();
        renderStatic();
      }
    }

    function showPhotoModal(taskId, taskType = 'daily') {
      const task = taskType === 'daily'
        ? DAILY_TASKS.find(t => t.id === taskId)
        : EXTRA_MISSIONS.find(m => m.id === taskId);

      if (!task) return;

      const modal = document.createElement('div');
      modal.className = 'photo-modal';
      modal.onclick = function(e) {
        if (e.target === modal) closePhotoModal();
      };
      modal.innerHTML = `
        <div class="photo-modal-content" onclick="event.stopPropagation()">
          <h2 class="text-2xl font-bold text-dark mb-2">üì∏ Proof Required</h2>
          <p class="text-sm text-medium mb-4">Take a photo to verify: ${task.name}</p>

          <input type="file" id="photoInput" class="camera-input" accept="image/*" capture="environment">
          <img id="photoPreview" class="photo-preview" style="display: none;">

          <div class="flex gap-2">
            <button onclick="document.getElementById('photoInput').click()" class="btn-primary flex-1">
              üì∑ Take Photo
            </button>
            <button onclick="closePhotoModal()" class="btn-success flex-1">
              Cancel
            </button>
          </div>

          <button id="confirmBtn" onclick="confirmTaskWithPhoto('${taskId}', '${taskType}')" class="btn-primary w-full mt-3" style="display: none;">
            ‚úì Confirm Completion
          </button>
        </div>
      `;

      document.body.appendChild(modal);

      // Handle photo selection
      document.getElementById('photoInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(event) {
            const preview = document.getElementById('photoPreview');
            preview.src = event.target.result;
            preview.style.display = 'block';
            document.getElementById('confirmBtn').style.display = 'block';
            window.currentPhoto = event.target.result;
          };
          reader.readAsDataURL(file);
        }
      });
    }

    function closePhotoModal() {
      const modal = document.querySelector('.photo-modal');
      if (modal) modal.remove();
      window.currentPhoto = null;
    }

    function confirmTaskWithPhoto(taskId, taskType) {
      if (!window.currentPhoto) {
        showToast('No Photo', 'Please take a photo first', 'error');
        return;
      }

      const task = taskType === 'daily'
        ? DAILY_TASKS.find(t => t.id === taskId)
        : EXTRA_MISSIONS.find(m => m.id === taskId);

      if (!task) return;

      // Mark as complete
      if (taskType === 'daily') {
        state.completed[taskId] = true;
      } else {
        state.extraMissions[taskId] = Date.now();
      }

      // Add rewards
      state.xp += task.xp;
      state.coins += task.coins;

      for (const [stat, value] of Object.entries(task.stats || {})) {
        state.stats[stat] += value;
      }

      // Save to completion history with photo
      const today = new Date().toISOString().split('T')[0];
      state.completionHistory.push({
        taskId: taskId,
        taskType: taskType,
        taskName: task.name,
        date: today,
        timestamp: Date.now(),
        photo: window.currentPhoto,
        xp: task.xp,
        coins: task.coins
      });

      checkLevelUp();
      playSound('complete');
      showToast(task.name, `+${task.xp} XP, +${task.coins} coins`, 'success');

      closePhotoModal();
      saveState();
      renderStatic();
    }

    function checkLevelUp() {
      const xpNeeded = Math.floor(100 * Math.pow(state.level, 1.2));
      if (state.xp >= xpNeeded) {
        state.level++;
        state.xp -= xpNeeded;
        showToast('Level Up!', `You reached level ${state.level}`, 'success');
        return true;
      }
      return false;
    }

    function completeExtraMission(missionId) {
      const mission = EXTRA_MISSIONS.find(m => m.id === missionId);
      if (!mission) return;

      if (state.extraMissions[missionId]) {
        const lastCompletion = state.extraMissions[missionId];
        const hoursPassed = (Date.now() - lastCompletion) / (1000 * 60 * 60);
        if (hoursPassed < mission.cooldown) {
          showToast('On Cooldown', `Wait ${Math.ceil(mission.cooldown - hoursPassed)} hours`, 'error');
          return;
        }
      }

      // Show photo modal for extra mission
      showPhotoModal(missionId, 'extra');
    }

    function buyReward(rewardId) {
      const reward = REWARDS.find(r => r.id === rewardId);
      if (!reward) return;

      if (state.coins < reward.price) {
        showToast('Not Enough Coins', `Need ${reward.price} coins`, 'error');
        return;
      }

      state.coins -= reward.price;
      state.rewards.push({ id: rewardId, acquired: Date.now(), used: false });

      showToast('Reward Purchased!', `${reward.name} added to inventory`, 'success');
      playSound('complete');
      saveState();
      renderStatic();
    }

    function claimReward(rewardId, acquired) {
      const reward = REWARDS.find(r => r.id === rewardId);
      if (!reward) return;

      // Find the specific item in inventory and mark as used
      const item = state.rewards.find(r => r.id === rewardId && r.acquired === acquired && !r.used);
      if (!item) return;

      item.used = true;

      showToast('Reward Claimed!', `Enjoy your ${reward.name}!`, 'success');
      playSound('complete');
      saveState();
      renderStatic();
    }

    function updateCalories() {
      const cal = parseFloat(document.getElementById('calInput').value) || 0;
      const pro = parseFloat(document.getElementById('proInput').value) || 0;
      const carb = parseFloat(document.getElementById('carbInput').value) || 0;
      const fat = parseFloat(document.getElementById('fatInput').value) || 0;

      state.manualCalories += cal;
      state.manualProtein += pro;
      state.manualCarbs += carb;
      state.manualFats += fat;

      document.getElementById('calInput').value = '';
      document.getElementById('proInput').value = '';
      document.getElementById('carbInput').value = '';
      document.getElementById('fatInput').value = '';

      saveState();
      renderStatic();
    }

    function logWeight(weight) {
      const today = new Date().toISOString().split('T')[0];
      const lastWeighIn = state.lastWeighIn;

      if (lastWeighIn) {
        const lastDate = new Date(lastWeighIn);
        const daysSince = Math.floor((new Date(today) - lastDate) / (1000 * 60 * 60 * 24));

        if (daysSince < 7) {
          showToast('Too Soon', `Weigh in every 7 days (${7 - daysSince} days left)`, 'error');
          return;
        }
      }

      state.currentWeight = weight;
      state.weightHistory.push({ date: today, weight: weight });
      state.lastWeighIn = today;

      saveState();
      renderStatic();
      showToast('Weight Logged', `${weight} lbs recorded`, 'success');
    }

    function secondsToMidnight() {
      const now = new Date();
      const options = { timeZone: 'America/New_York', hour12: false };
      const etString = now.toLocaleString('en-US', options);
      const etDate = new Date(etString);

      const midnight = new Date(etDate);
      midnight.setHours(24, 0, 0, 0); // 12:00 AM next day

      if (etDate > midnight) {
        midnight.setDate(midnight.getDate() + 1);
      }

      const diff = midnight - etDate;
      return Math.max(0, Math.floor(diff / 1000));
    }

    function formatTime(seconds) {
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = seconds % 60;
      return `${h}h ${m}m ${s}s`;
    }

    function showToast(title, message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.innerHTML = `
        <div class="font-bold text-sm mb-1 text-dark">${title}</div>
        <div class="text-xs text-medium">${message}</div>
      `;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    function playSound(type) {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain);
      gain.connect(ctx.destination);

      if (type === 'complete') {
        osc.frequency.value = 800;
        gain.gain.setValueAtTime(0.05, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + 0.1);
      }
    }

    function switchTab(tab) {
      state.currentTab = tab;
      renderStatic();
    }

    function addShortForm() {
      state.shortFormCount++;
      if (state.shortFormCount >= 2 && !state.completed.short) {
        toggleTask('short');
      }
      saveState();
      renderStatic();
    }

    // Separate render for static content (doesn't update every second)
    function renderStatic() {
      const app = document.getElementById('app');
      const tasksComplete = DAILY_TASKS.filter(t => state.completed[t.id]).length;
      const tasksTotal = DAILY_TASKS.length;
      const xpNeeded = Math.floor(100 * Math.pow(state.level, 1.2));
      const xpPercent = (state.xp / xpNeeded) * 100;
      const weightLost = state.startWeight - state.currentWeight;
      const weightRemaining = state.currentWeight - state.targetWeight;
      const progressPercent = ((weightLost) / (state.startWeight - state.targetWeight)) * 100;

      if (state.currentTab === 'home') {
        app.innerHTML = `
          <!-- Status Window (Static) -->
          <div class="status-window rounded-2xl p-6 mb-4">
            <div class="flex justify-between items-start mb-4">
              <div>
                <h1 class="text-3xl font-bold text-dark mb-1">SENSE</h1>
                <p class="text-sm text-medium">Level up your life</p>
              </div>
              <div class="level-badge text-lg">
                LV ${state.level}
              </div>
            </div>

            <!-- Weight -->
            <div class="mb-4">
              <div class="flex justify-between text-sm mb-2">
                <span class="font-semibold text-dark">Weight</span>
                <span class="text-medium">${state.currentWeight} ‚Üí ${state.targetWeight} lbs</span>
              </div>
              <div class="progress-container">
                <div class="progress-bar" style="width: ${progressPercent}%"></div>
              </div>
              <div class="flex justify-between text-xs text-medium mt-1">
                <span>${weightLost} lbs lost</span>
                <span>${weightRemaining} lbs to go</span>
              </div>
            </div>

            <!-- XP -->
            <div class="mb-4">
              <div class="flex justify-between text-sm mb-2">
                <span class="font-semibold text-dark">Experience</span>
                <span class="text-medium">${state.xp} / ${xpNeeded} XP</span>
              </div>
              <div class="progress-container">
                <div class="progress-bar" style="width: ${xpPercent}%"></div>
              </div>
            </div>

            <!-- Coins -->
            <div class="flex gap-6">
              <div class="text-center">
                <div class="text-2xl font-bold text-dark">${state.coins}</div>
                <div class="text-xs text-medium">Coins</div>
              </div>
            </div>
          </div>

          <!-- Shiny Streak Badge -->
          <div class="mb-4 text-center">
            <div class="streak-badge">
              <div class="streak-number">üî• ${state.streak}</div>
              <div class="streak-label">Day Streak</div>
            </div>
          </div>

          <!-- Rank Badge -->
          ${(() => {
            const { rank, totalStats } = getCurrentRank();
            const { nextRank, progress, statsNeeded } = getNextRank();
            return `
              <div class="glass rounded-2xl p-4 mb-4">
                <div class="flex justify-between items-center mb-3">
                  <div class="rank-badge" style="background: ${rank.gradient};">
                    <span class="rank-icon">${rank.icon}</span>
                    <span class="rank-name" style="color: ${rank.name === 'Unranked' ? '#FFFFFF' : '#0A1628'};">${rank.name}</span>
                  </div>
                  <div class="text-cream text-sm font-semibold">${totalStats} Stats</div>
                </div>
                ${nextRank ? `
                  <div>
                    <div class="flex justify-between text-xs text-medium mb-1">
                      <span>Next: ${nextRank.icon} ${nextRank.name}</span>
                      <span>${statsNeeded} stats needed</span>
                    </div>
                    <div class="progress-container">
                      <div class="progress-bar" style="width: ${progress}%;"></div>
                    </div>
                  </div>
                ` : `
                  <div class="text-center text-sm font-bold text-gold">‚≠ê MAX RANK ACHIEVED ‚≠ê</div>
                `}
              </div>
            `;
          })()}

          <!-- Timer (will update separately) -->
          <div id="timer" class="glass rounded-2xl p-5 mb-4 text-center timer-urgent">
            <div class="text-sm font-semibold mb-2 opacity-90">‚è∞ Time Until 12:00 AM ET</div>
            <div class="text-4xl font-bold mb-2">--:--:--</div>
            <div class="text-sm opacity-90">${tasksComplete}/${tasksTotal} tasks complete</div>
          </div>

          <!-- Daily Tasks -->
          <div class="glass rounded-2xl p-6 mb-4">
            <h2 class="text-lg font-bold text-cream mb-4">
              <span class="mission-badge badge-extra">DAILY</span> Daily Tasks
            </h2>
            ${DAILY_TASKS.map(task => `
              <div class="task-card ${state.completed[task.id] ? 'completed' : ''}">
                <div class="flex items-center justify-between">
                  <div class="flex-1">
                    <div class="font-semibold text-dark mb-1">${task.name}</div>
                    <div class="text-xs text-medium mb-2">${task.desc}</div>
                    ${task.id === 'short' ? `
                      <div class="text-xs text-medium mb-2">Videos: ${state.shortFormCount}/2</div>
                      ${!state.completed.short && state.shortFormCount < 2 ? `
                        <button onclick="addShortForm()" class="btn-primary text-xs px-3 py-1 mb-2">
                          +1 Video
                        </button>
                      ` : ''}
                    ` : ''}
                    <div class="text-xs text-medium">+${task.xp} XP, +${task.coins} coins</div>
                  </div>
                  <button
                    onclick="toggleTask('${task.id}')"
                    class="${state.completed[task.id] ? 'btn-success' : 'btn-primary'}"
                    style="min-width: 90px;"
                    ${task.id === 'short' && state.shortFormCount < 2 ? 'disabled' : ''}
                  >
                    ${state.completed[task.id] ? '‚úì Done' : 'Complete'}
                  </button>
                </div>
              </div>
            `).join('')}
          </div>

          <div class="fixed bottom-0 left-0 right-0 glass-dark p-3 flex gap-1 justify-around">
            <button onclick="switchTab('home')" class="tab active">Home</button>
            <button onclick="switchTab('missions')" class="tab">Missions</button>
            <button onclick="switchTab('rewards')" class="tab">Rewards</button>
            <button onclick="switchTab('stats')" class="tab">Stats</button>
            <button onclick="switchTab('track')" class="tab">Track</button>
            <button onclick="switchTab('profile')" class="tab">Profile</button>
          </div>
        `;
      } else if (state.currentTab === 'missions') {
        const extraMissions = EXTRA_MISSIONS.filter(m => m.type === 'extra');
        const weeklyMissions = EXTRA_MISSIONS.filter(m => m.type === 'weekly');
        const epicMissions = EXTRA_MISSIONS.filter(m => m.type === 'epic');

        app.innerHTML = `
          <div class="mb-20">
            <div class="status-window rounded-2xl p-6 mb-4">
              <h1 class="text-2xl font-bold text-dark mb-2">üéØ Extra Missions</h1>
              <p class="text-sm text-medium">Bonus tasks for extra rewards</p>
            </div>

            <div class="glass rounded-2xl p-6 mb-4">
              <h2 class="text-lg font-bold text-cream mb-4">
                <span class="mission-badge badge-extra">EXTRA</span> Daily Bonus
              </h2>
              ${extraMissions.map(mission => {
                const lastCompletion = state.extraMissions[mission.id];
                const hoursPassed = lastCompletion ? (Date.now() - lastCompletion) / (1000 * 60 * 60) : 999;
                const canDo = hoursPassed >= mission.cooldown;
                return `
                  <div class="task-card ${!canDo ? 'opacity-50' : ''}">
                    <div class="flex items-center justify-between">
                      <div class="flex-1">
                        <div class="font-semibold text-dark mb-1">${mission.name}</div>
                        <div class="text-xs text-medium mb-2">${mission.desc}</div>
                        <div class="text-xs text-medium">+${mission.xp} XP, +${mission.coins} coins</div>
                        ${!canDo && lastCompletion ? `
                          <div class="text-xs text-medium mt-1">‚è±Ô∏è ${Math.ceil(mission.cooldown - hoursPassed)}h</div>
                        ` : ''}
                      </div>
                      <button
                        onclick="completeExtraMission('${mission.id}')"
                        class="${canDo ? 'btn-primary' : 'btn-success opacity-50'}"
                        ${!canDo ? 'disabled' : ''}
                      >
                        ${canDo ? 'Complete' : 'Done'}
                      </button>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>

            <div class="glass rounded-2xl p-6 mb-4">
              <h2 class="text-lg font-bold text-cream mb-4">
                <span class="mission-badge badge-weekly">WEEKLY</span> Weekly
              </h2>
              ${weeklyMissions.map(mission => {
                const lastCompletion = state.extraMissions[mission.id];
                const hoursPassed = lastCompletion ? (Date.now() - lastCompletion) / (1000 * 60 * 60) : 999;
                const canDo = hoursPassed >= mission.cooldown;
                return `
                  <div class="task-card ${!canDo ? 'opacity-50' : ''}">
                    <div class="flex items-center justify-between">
                      <div class="flex-1">
                        <div class="font-semibold text-dark mb-1">${mission.name}</div>
                        <div class="text-xs text-medium mb-2">${mission.desc}</div>
                        <div class="text-xs text-medium">+${mission.xp} XP, +${mission.coins} coins</div>
                      </div>
                      <button
                        onclick="completeExtraMission('${mission.id}')"
                        class="${canDo ? 'btn-primary' : 'btn-success opacity-50'}"
                        ${!canDo ? 'disabled' : ''}
                      >
                        ${canDo ? 'Complete' : 'Done'}
                      </button>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>

            <div class="glass rounded-2xl p-6 mb-4">
              <h2 class="text-lg font-bold text-cream mb-4">
                <span class="mission-badge badge-epic">EPIC</span> Epic
              </h2>
              ${epicMissions.map(mission => {
                const completed = state.extraMissions[mission.id];
                let canDo = false;

                if (mission.id === 'weight_10') canDo = state.currentWeight <= 250;
                if (mission.id === 'level_10') canDo = state.level >= 10;
                if (mission.id === 'month_streak') canDo = state.streak >= 30;

                return `
                  <div class="task-card ${completed ? 'opacity-50' : canDo ? 'border-2 border-teal' : ''}">
                    <div class="flex items-center justify-between">
                      <div class="flex-1">
                        <div class="font-semibold text-dark mb-1">${mission.name}</div>
                        <div class="text-xs text-medium mb-2">${mission.desc}</div>
                        <div class="text-xs text-medium">+${mission.xp} XP, +${mission.coins} coins</div>
                      </div>
                      <button
                        onclick="completeExtraMission('${mission.id}')"
                        class="${canDo && !completed ? 'btn-primary' : 'btn-success opacity-50'}"
                        ${!canDo || completed ? 'disabled' : ''}
                      >
                        ${completed ? '‚úì Claimed' : canDo ? 'Claim' : 'Locked'}
                      </button>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>

          <div class="fixed bottom-0 left-0 right-0 glass-dark p-3 flex gap-1 justify-around">
            <button onclick="switchTab('home')" class="tab">Home</button>
            <button onclick="switchTab('missions')" class="tab active">Missions</button>
            <button onclick="switchTab('rewards')" class="tab">Rewards</button>
            <button onclick="switchTab('stats')" class="tab">Stats</button>
            <button onclick="switchTab('track')" class="tab">Track</button>
            <button onclick="switchTab('profile')" class="tab">Profile</button>
          </div>
        `;
      } else if (state.currentTab === 'rewards') {
        app.innerHTML = `
          <div class="mb-20">
            <div class="status-window rounded-2xl p-6 mb-4">
              <h1 class="text-2xl font-bold text-dark mb-2">üè™ Lifestyle Rewards</h1>
              <p class="text-sm text-medium">Earn rewards for staying disciplined</p>
              <div class="text-3xl font-bold text-dark mt-2">${state.coins} coins</div>
            </div>

            <!-- Inventory Section -->
            ${state.rewards.filter(r => !r.used).length > 0 ? `
              <div class="glass rounded-2xl p-6 mb-4">
                <h2 class="text-xl font-bold text-cream mb-4">üéí Your Inventory</h2>
                <div class="space-y-3">
                  ${state.rewards.filter(r => !r.used).map(item => {
                    const reward = REWARDS.find(rw => rw.id === item.id);
                    if (!reward) return '';
                    return `
                      <div class="reward-item">
                        <div class="flex justify-between items-center">
                          <div class="flex items-center gap-3 flex-1">
                            <div class="text-3xl">${reward.icon}</div>
                            <div class="flex-1">
                              <div class="font-bold text-dark">${reward.name}</div>
                              <div class="text-xs text-medium">${reward.desc}</div>
                            </div>
                          </div>
                          <button
                            onclick="claimReward('${item.id}', ${item.acquired})"
                            class="btn-success px-6 py-2 text-sm"
                          >
                            Claim
                          </button>
                        </div>
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
            ` : ''}

            <div class="glass rounded-2xl p-6 mb-4">
              <h2 class="text-xl font-bold text-cream mb-4">üõí Store</h2>
            </div>

            <div class="grid grid-cols-1 gap-4 mb-4">
              ${REWARDS.map(reward => {
                const owned = state.rewards.filter(r => r.id === reward.id && !r.used).length;
                return `
                  <div class="reward-item">
                    <div class="flex justify-between items-start mb-3">
                      <div class="flex items-start gap-3 flex-1">
                        <div class="text-4xl">${reward.icon}</div>
                        <div class="flex-1">
                          <div class="font-bold text-dark text-lg mb-1">${reward.name}</div>
                          <div class="text-sm text-medium mb-2">${reward.desc}</div>
                          ${owned > 0 ? `
                            <div class="text-xs text-medium">Owned: ${owned}</div>
                          ` : ''}
                        </div>
                      </div>
                      <div class="text-right ml-4">
                        <div class="text-2xl font-bold text-dark mb-1">${reward.price}</div>
                        <div class="text-xs text-medium">coins</div>
                      </div>
                    </div>
                    <button
                      onclick="buyReward('${reward.id}')"
                      class="${state.coins >= reward.price ? 'btn-reward' : 'btn-success opacity-50'} w-full"
                      ${state.coins < reward.price ? 'disabled' : ''}
                    >
                      ${state.coins >= reward.price ? 'Buy & Add to Inventory' : 'Not Enough Coins'}
                    </button>
                  </div>
                `;
              }).join('')}
            </div>
          </div>

          <div class="fixed bottom-0 left-0 right-0 glass-dark p-3 flex gap-1 justify-around">
            <button onclick="switchTab('home')" class="tab">Home</button>
            <button onclick="switchTab('missions')" class="tab">Missions</button>
            <button onclick="switchTab('rewards')" class="tab active">Rewards</button>
            <button onclick="switchTab('stats')" class="tab">Stats</button>
            <button onclick="switchTab('track')" class="tab">Track</button>
            <button onclick="switchTab('profile')" class="tab">Profile</button>
          </div>
        `;
      } else if (state.currentTab === 'stats') {
        app.innerHTML = `
          <div class="mb-20">
            <div class="status-window rounded-2xl p-6 mb-4">
              <h1 class="text-2xl font-bold text-dark mb-2">üìä Your Stats</h1>
              <p class="text-sm text-medium">Track your growth</p>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-4">
              ${Object.entries(state.stats).map(([key, val]) => {
                const info = STAT_INFO[key];
                return `
                  <div class="glass rounded-2xl p-5 text-center">
                    <div class="text-5xl font-bold mb-2" style="color: ${info.color};">
                      ${val}
                    </div>
                    <div class="text-sm font-semibold text-dark">${info.name}</div>
                    <div class="text-xs text-medium mt-1">${info.desc}</div>
                  </div>
                `;
              }).join('')}
            </div>

            <div class="glass rounded-2xl p-6 mb-4">
              <h2 class="text-lg font-bold text-cream mb-4">Stat Guide</h2>
              <div class="space-y-3 text-sm">
                ${Object.entries(STAT_INFO).map(([key, info]) => `
                  <div class="flex items-start gap-3">
                    <div class="w-12 h-12 rounded-xl flex items-center justify-center font-bold text-white text-xs"
                         style="background: ${info.color};">
                      ${key.toUpperCase()}
                    </div>
                    <div>
                      <div class="font-semibold text-cream">${info.name}</div>
                      <div class="text-xs text-medium">${info.desc}</div>
                      <div class="text-xs text-medium mt-1">Gain: ${info.gains}</div>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>

            <div class="glass rounded-2xl p-6">
              <h2 class="text-lg font-bold text-cream mb-4">üèÜ Rank System</h2>
              <p class="text-xs text-medium mb-4">Rank up by gaining total stats from completing tasks!</p>
              <div class="space-y-3 text-sm">
                ${RANKS.map((rank, index) => {
                  const { rank: currentRank } = getCurrentRank();
                  const isCurrent = rank.name === currentRank.name;
                  return `
                    <div class="flex items-center gap-3 ${isCurrent ? 'bg-gold bg-opacity-20 p-2 rounded-lg' : ''}">
                      <div class="rank-badge" style="background: ${rank.gradient}; padding: 8px 12px;">
                        <span class="rank-icon" style="font-size: 20px;">${rank.icon}</span>
                        <span class="rank-name" style="font-size: 14px; color: ${rank.name === 'Unranked' ? '#FFFFFF' : '#0A1628'};">${rank.name}</span>
                      </div>
                      <div class="flex-1">
                        <div class="text-xs text-cream font-semibold">${rank.minStats} Total Stats</div>
                        ${isCurrent ? `<div class="text-xs text-gold font-bold">‚Üê You are here</div>` : ''}
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          </div>

          <div class="fixed bottom-0 left-0 right-0 glass-dark p-3 flex gap-1 justify-around">
            <button onclick="switchTab('home')" class="tab">Home</button>
            <button onclick="switchTab('missions')" class="tab">Missions</button>
            <button onclick="switchTab('rewards')" class="tab">Rewards</button>
            <button onclick="switchTab('stats')" class="tab active">Stats</button>
            <button onclick="switchTab('track')" class="tab">Track</button>
            <button onclick="switchTab('profile')" class="tab">Profile</button>
          </div>
        `;
      } else if (state.currentTab === 'track') {
        const daysSinceWeighIn = state.lastWeighIn ?
          Math.floor((new Date() - new Date(state.lastWeighIn)) / (1000 * 60 * 60 * 24)) : 999;
        const canWeighIn = daysSinceWeighIn >= 7;

        app.innerHTML = `
          <div class="mb-20">
            <!-- Calorie Calculator -->
            <div class="glass rounded-2xl p-6 mb-4">
              <h2 class="text-xl font-bold text-cream mb-4">üçΩÔ∏è Calorie Tracker</h2>

              <div class="mb-4">
                <div class="flex justify-between text-sm mb-2">
                  <span class="font-semibold text-dark">Calories</span>
                  <span class="text-medium">${state.manualCalories} / ${state.calorieTarget}</span>
                </div>
                <div class="progress-container">
                  <div class="progress-bar" style="width: ${Math.min(100, (state.manualCalories / state.calorieTarget) * 100)}%"></div>
                </div>
              </div>

              <div class="grid grid-cols-3 gap-3 mb-4">
                <div class="text-center">
                  <div class="text-2xl font-bold text-medium">${state.manualProtein}g</div>
                  <div class="text-xs text-medium">Protein</div>
                </div>
                <div class="text-center">
                  <div class="text-2xl font-bold text-medium">${state.manualCarbs}g</div>
                  <div class="text-xs text-medium">Carbs</div>
                </div>
                <div class="text-center">
                  <div class="text-2xl font-bold text-medium">${state.manualFats}g</div>
                  <div class="text-xs text-medium">Fats</div>
                </div>
              </div>

              <div class="space-y-2 mb-3">
                <input type="number" id="calInput" placeholder="Calories" class="w-full glass rounded-lg px-4 py-3 text-dark font-semibold" />
                <input type="number" id="proInput" placeholder="Protein (g)" class="w-full glass rounded-lg px-4 py-3 text-dark font-semibold" />
                <input type="number" id="carbInput" placeholder="Carbs (g)" class="w-full glass rounded-lg px-4 py-3 text-dark font-semibold" />
                <input type="number" id="fatInput" placeholder="Fats (g)" class="w-full glass rounded-lg px-4 py-3 text-dark font-semibold" />
              </div>

              <button onclick="updateCalories()" class="btn-primary w-full">Add to Daily Total</button>
            </div>

            <!-- Workout Knowledge Base -->
            <div class="glass rounded-2xl p-6 mb-4">
              <h2 class="text-xl font-bold text-cream mb-4">üí™ Workout Library</h2>

              <div class="flex gap-2 mb-4">
                ${['push', 'pull', 'legs'].map(day => `
                  <button
                    onclick="state.currentDay='${day}'; saveState(); renderStatic();"
                    class="${state.currentDay === day ? 'btn-primary' : 'task-card'} flex-1 py-2 text-sm font-bold text-dark"
                  >
                    ${day.toUpperCase()}
                  </button>
                `).join('')}
              </div>

              <div class="space-y-3">
                ${WORKOUT_KB[state.currentDay].map(ex => `
                  <div class="workout-card">
                    <img src="${ex.img}" alt="${ex.name}" class="workout-img" onerror="this.style.display='none'" />
                    <div class="font-semibold text-dark mb-1">${ex.name}</div>
                    <div class="text-xs text-medium mb-1">Target: ${ex.muscle}</div>
                    <div class="text-xs text-dark mb-1">${ex.desc}</div>
                    <div class="text-xs text-medium">üí° ${ex.tips}</div>
                  </div>
                `).join('')}
              </div>
            </div>

            <!-- Weekly Weight Check-in -->
            <div class="glass rounded-2xl p-6 mb-4">
              <h2 class="text-xl font-bold text-cream mb-4">‚öñÔ∏è Weekly Weight Check-in</h2>

              ${state.lastWeighIn ? `
                <div class="text-sm text-medium mb-3">
                  Last weigh-in: ${state.lastWeighIn} (${daysSinceWeighIn} days ago)
                </div>
              ` : ''}

              ${!canWeighIn ? `
                <div class="bg-medium rounded-xl p-4 mb-3">
                  <div class="text-sm font-semibold text-cream mb-2">‚è±Ô∏è Next Check-in Available In:</div>
                  <div id="weighInTimer" class="text-2xl font-bold text-cream mb-3">--d --h --m</div>
                  <div class="progress-container">
                    <div class="progress-bar" style="width: ${(daysSinceWeighIn / 7) * 100}%"></div>
                  </div>
                  <div class="text-xs text-cream mt-2 opacity-75">${daysSinceWeighIn} of 7 days completed</div>
                </div>
              ` : `
                <div class="bg-medium rounded-xl p-4 mb-3">
                  <div class="text-lg font-bold text-cream text-center">‚úÖ Ready to Check In!</div>
                </div>
              `}

              <div class="flex gap-2 mb-3">
                <input
                  type="number"
                  id="weightInput"
                  placeholder="${state.currentWeight}"
                  class="flex-1 glass rounded-xl px-4 py-3 text-dark font-semibold"
                  step="0.1"
                  ${!canWeighIn ? 'disabled' : ''}
                />
                <button
                  onclick="const w = parseFloat(document.getElementById('weightInput').value); if(w) logWeight(w);"
                  class="${canWeighIn ? 'btn-primary' : 'btn-success opacity-50'} px-6"
                  ${!canWeighIn ? 'disabled' : ''}
                >
                  LOG
                </button>
              </div>

              ${state.weightHistory.length > 0 ? `
                <div class="text-xs text-medium">
                  History: ${state.weightHistory.slice(-4).map(w => `${w.weight} lbs`).join(', ')}
                </div>
              ` : ''}
            </div>
          </div>

          <div class="fixed bottom-0 left-0 right-0 glass-dark p-3 flex gap-1 justify-around">
            <button onclick="switchTab('home')" class="tab">Home</button>
            <button onclick="switchTab('missions')" class="tab">Missions</button>
            <button onclick="switchTab('rewards')" class="tab">Rewards</button>
            <button onclick="switchTab('stats')" class="tab">Stats</button>
            <button onclick="switchTab('track')" class="tab active">Track</button>
            <button onclick="switchTab('profile')" class="tab">Profile</button>
          </div>
        `;
      } else if (state.currentTab === 'profile') {
        // Group completions by date
        const groupedByDate = {};
        state.completionHistory.forEach(completion => {
          if (!groupedByDate[completion.date]) {
            groupedByDate[completion.date] = [];
          }
          groupedByDate[completion.date].push(completion);
        });

        // Sort dates in descending order (newest first)
        const sortedDates = Object.keys(groupedByDate).sort((a, b) => b.localeCompare(a));

        app.innerHTML = `
          <div class="mb-20">
            <div class="status-window rounded-2xl p-6 mb-4">
              <h1 class="text-2xl font-bold text-dark mb-2">üìÖ Completion History</h1>
              <p class="text-sm text-medium">Your verified task completions with photo proof</p>
              <div class="flex gap-4 mt-3">
                <div>
                  <div class="text-2xl font-bold text-dark">${state.streak}</div>
                  <div class="text-xs text-medium">Day Streak</div>
                </div>
                <div>
                  <div class="text-2xl font-bold text-dark">${state.completionHistory.length}</div>
                  <div class="text-xs text-medium">Total Completions</div>
                </div>
                <div>
                  <div class="text-2xl font-bold text-dark">${sortedDates.length}</div>
                  <div class="text-xs text-medium">Active Days</div>
                </div>
              </div>
            </div>

            ${sortedDates.length === 0 ? `
              <div class="glass rounded-2xl p-8 text-center">
                <div class="text-6xl mb-4">üì∏</div>
                <h3 class="text-xl font-bold text-cream mb-2">No Completions Yet</h3>
                <p class="text-sm text-medium">Complete tasks with photo proof to see your history here!</p>
              </div>
            ` : ''}

            ${sortedDates.map(date => {
              const completions = groupedByDate[date];
              const dateObj = new Date(date);
              const isToday = date === new Date().toISOString().split('T')[0];
              const dayName = isToday ? 'Today' : dateObj.toLocaleDateString('en-US', { weekday: 'long' });
              const dateStr = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

              return `
                <div class="glass rounded-2xl p-4 mb-4">
                  <div class="flex justify-between items-center mb-3">
                    <div>
                      <h3 class="text-lg font-bold text-cream">${dayName}</h3>
                      <p class="text-xs text-medium">${dateStr}</p>
                    </div>
                    <div class="text-right">
                      <div class="text-sm font-bold text-cream">${completions.length} tasks</div>
                      <div class="text-xs text-medium">+${completions.reduce((sum, c) => sum + c.xp, 0)} XP</div>
                    </div>
                  </div>

                  <div class="space-y-3">
                    ${completions.map(completion => `
                      <div class="calendar-day">
                        <div class="flex justify-between items-start mb-2">
                          <div class="flex-1">
                            <div class="font-bold text-dark mb-1">${completion.taskName}</div>
                            <div class="flex gap-1 flex-wrap">
                              <span class="task-badge">${completion.taskType.toUpperCase()}</span>
                              <span class="task-badge">+${completion.xp} XP</span>
                              <span class="task-badge">+${completion.coins} coins</span>
                            </div>
                          </div>
                          <div class="text-xs text-medium">
                            ${new Date(completion.timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}
                          </div>
                        </div>
                        ${completion.photo ? `
                          <img
                            src="${completion.photo}"
                            class="proof-image"
                            onclick="viewFullImage('${completion.photo.replace(/'/g, "\\'")}')"
                            alt="Task proof photo"
                          />
                        ` : ''}
                      </div>
                    `).join('')}
                  </div>
                </div>
              `;
            }).join('')}
          </div>

          <div class="fixed bottom-0 left-0 right-0 glass-dark p-3 flex gap-1 justify-around">
            <button onclick="switchTab('home')" class="tab">Home</button>
            <button onclick="switchTab('missions')" class="tab">Missions</button>
            <button onclick="switchTab('rewards')" class="tab">Rewards</button>
            <button onclick="switchTab('stats')" class="tab">Stats</button>
            <button onclick="switchTab('track')" class="tab">Track</button>
            <button onclick="switchTab('profile')" class="tab active">Profile</button>
          </div>
        `;
      }
    }

    // Timer updates every second (separate from static content)
    function updateTimer() {
      const timerEl = document.getElementById('timer');
      if (timerEl) {
        const remaining = secondsToMidnight();
        const tasksComplete = DAILY_TASKS.filter(t => state.completed[t.id]).length;
        const tasksTotal = DAILY_TASKS.length;

        timerEl.querySelector('.text-4xl').textContent = formatTime(remaining);
        timerEl.querySelector('.text-sm.opacity-90:last-child').textContent = `${tasksComplete}/${tasksTotal} tasks complete`;
      }

      // Update weight check-in timer
      const weighInTimerEl = document.getElementById('weighInTimer');
      if (weighInTimerEl && state.lastWeighIn) {
        const lastDate = new Date(state.lastWeighIn);
        const nextWeighIn = new Date(lastDate.getTime() + 7 * 24 * 60 * 60 * 1000); // 7 days later
        const now = new Date();
        const diff = nextWeighIn - now;

        if (diff > 0) {
          const days = Math.floor(diff / (1000 * 60 * 60 * 24));
          const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
          const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
          weighInTimerEl.textContent = `${days}d ${hours}h ${minutes}m`;
        } else {
          weighInTimerEl.textContent = 'Ready!';
        }
      }
    }

    // View full-size image modal
    function viewFullImage(imageSrc) {
      const modal = document.createElement('div');
      modal.className = 'photo-modal';
      modal.onclick = function(e) {
        if (e.target === modal) modal.remove();
      };
      modal.innerHTML = `
        <div class="photo-modal-content" style="max-width: 90%; max-height: 90vh;">
          <div class="flex justify-between items-center mb-3">
            <h2 class="text-xl font-bold text-dark">Task Proof</h2>
            <button onclick="this.closest('.photo-modal').remove()" class="text-dark font-bold text-2xl">&times;</button>
          </div>
          <img src="${imageSrc}" style="width: 100%; height: auto; border-radius: 12px; max-height: 70vh; object-fit: contain;">
        </div>
      `;
      document.body.appendChild(modal);
    }

    loadState();
    renderStatic();
    setInterval(updateTimer, 1000);

    window.toggleTask = toggleTask;
    window.completeExtraMission = completeExtraMission;
    window.buyReward = buyReward;
    window.claimReward = claimReward;
    window.updateCalories = updateCalories;
    window.logWeight = logWeight;
    window.switchTab = switchTab;
    window.addShortForm = addShortForm;
    window.closePhotoModal = closePhotoModal;
    window.confirmTaskWithPhoto = confirmTaskWithPhoto;
    window.viewFullImage = viewFullImage;
    window.state = state;
    window.saveState = saveState;
    window.renderStatic = renderStatic;
  </script>
</body>
</html>
