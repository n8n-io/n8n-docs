<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SENSE - Complete Life RPG</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { margin: 0; padding: 0; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); } 20%, 40%, 60%, 80% { transform: translateX(5px); } }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes scaleIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    .animate-shake { animation: shake 0.5s ease-in-out; }
    .animate-slideIn { animation: slideIn 0.3s ease-out; }
    .animate-scaleIn { animation: scaleIn 0.3s ease-out; }
    .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
    .glow-gold { box-shadow: 0 0 20px rgba(234, 179, 8, 0.3); }
    .glow-red { box-shadow: 0 0 30px rgba(239, 68, 68, 0.5); }
    .glow-blue { box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); }
    .glow-green { box-shadow: 0 0 20px rgba(34, 197, 94, 0.3); }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef, useCallback } = React;

    // ============= CONFIGURATION =============
    const XP_PER_COIN = 3;
    const MISSION_COOLDOWN_MS = 25 * 60 * 1000;
    const STORAGE_KEY = 'sense_complete_v1';
    const STORAGE_DATE_KEY = 'sense_last_date_v1';
    const UNDO_WINDOW_MS = 5000;
    const PENALTY_XP_LOSS = 100;
    const PENALTY_STAT_DECAY = 5;
    const PENALTY_COIN_LOSS = 50;
    const DAILY_KCAL_TARGET = 2000;
    const XP_PER_FOOD_LOG = 10;
    const XP_FOR_HITTING_TARGET = 100;

    // ============= DATA =============
    const characterClasses = {
      warrior: { name: 'Warrior', icon: 'üó°Ô∏è', desc: 'Physical fitness master', bonus: 'strength' },
      scholar: { name: 'Scholar', icon: 'üß†', desc: 'Knowledge seeker', bonus: 'intelligence' },
      entrepreneur: { name: 'Entrepreneur', icon: 'üíº', desc: 'Wealth builder', bonus: 'wealth' },
      creator: { name: 'Creator', icon: 'üé®', desc: 'Content legend', bonus: 'charisma' },
      hybrid: { name: 'Hybrid', icon: '‚öñÔ∏è', desc: 'Balanced approach', bonus: 'discipline' },
    };

    const dailyTasks = [
      { id: 'weights', label: 'Forge Your Body (Weights 60min)', xp: 60, stats: { strength: 3, discipline: 2 } },
      { id: 'cardio', label: "Warrior's Endurance (Cardio 45min)", xp: 45, stats: { endurance: 3, discipline: 2 } },
      { id: 'ai_learning', label: 'Study the Craft (AI 60min)', xp: 70, stats: { intelligence: 4, discipline: 2 } },
      { id: 'content', label: 'Share Your Journey (Post)', xp: 45, stats: { charisma: 3, discipline: 1 } },
      { id: 'bible', label: 'Spiritual Strength (Bible 15min)', xp: 30, stats: { discipline: 3, intelligence: 2 } },
    ];

    const missionPool = [
      { id: 'cold_shower', label: 'Cold Shower Challenge', xp: 25, stats: { discipline: 2, endurance: 1 } },
      { id: 'bonus_edit', label: 'Edit bonus video', xp: 40, stats: { charisma: 2 } },
      { id: 'gratitude', label: 'Write 3 gratitude lines', xp: 20, stats: { discipline: 2 } },
      { id: 'stretch', label: '10-min mobility', xp: 20, stats: { endurance: 2 } },
      { id: 'no_sugar', label: 'No sugar today', xp: 30, stats: { discipline: 3 } },
      { id: 'meditation', label: '10-min meditation', xp: 25, stats: { discipline: 2 } },
      { id: 'deep_work', label: '90-min deep work', xp: 50, stats: { discipline: 3, intelligence: 2 } },
    ];

    const foodDatabase = [
      { id: 'banana', name: 'Banana', calories: 105, protein: 1, carbs: 27, fats: 0, category: 'Fruit' },
      { id: 'apple', name: 'Apple', calories: 95, protein: 0, carbs: 25, fats: 0, category: 'Fruit' },
      { id: 'chicken_breast', name: 'Chicken Breast (100g)', calories: 165, protein: 31, carbs: 0, fats: 4, category: 'Protein' },
      { id: 'rice', name: 'White Rice (1 cup)', calories: 205, protein: 4, carbs: 45, fats: 0, category: 'Carbs' },
      { id: 'oatmeal', name: 'Oatmeal (1 cup)', calories: 150, protein: 6, carbs: 27, fats: 3, category: 'Carbs' },
      { id: 'eggs', name: 'Eggs (2 large)', calories: 140, protein: 12, carbs: 1, fats: 10, category: 'Protein' },
      { id: 'salmon', name: 'Salmon (100g)', calories: 206, protein: 22, carbs: 0, fats: 13, category: 'Protein' },
      { id: 'broccoli', name: 'Broccoli (1 cup)', calories: 31, protein: 3, carbs: 6, fats: 0, category: 'Vegetable' },
      { id: 'sweet_potato', name: 'Sweet Potato (medium)', calories: 112, protein: 2, carbs: 26, fats: 0, category: 'Carbs' },
      { id: 'protein_shake', name: 'Protein Shake', calories: 120, protein: 25, carbs: 3, fats: 2, category: 'Protein' },
      { id: 'almonds', name: 'Almonds (28g)', calories: 164, protein: 6, carbs: 6, fats: 14, category: 'Snack' },
      { id: 'greek_yogurt', name: 'Greek Yogurt (1 cup)', calories: 100, protein: 17, carbs: 6, fats: 0, category: 'Protein' },
      { id: 'avocado', name: 'Avocado', calories: 240, protein: 3, carbs: 13, fats: 22, category: 'Healthy Fat' },
      { id: 'pasta', name: 'Pasta (1 cup)', calories: 220, protein: 8, carbs: 43, fats: 1, category: 'Carbs' },
      { id: 'peanut_butter', name: 'Peanut Butter (2 tbsp)', calories: 188, protein: 8, carbs: 7, fats: 16, category: 'Snack' },
    ];

    const exerciseLibrary = [
      // CALISTHENICS
      { id: 'pushup', name: 'Push-Ups', type: 'calisthenics', muscle: 'Chest', difficulty: 'Beginner', desc: 'Classic bodyweight chest exercise', instructions: '1. Start in plank position\n2. Lower chest to ground\n3. Push back up\n4. Keep core tight', tips: 'Elbows at 45¬∞, don\'t flare out', videoUrl: 'https://cdn.coverr.co/videos/coverr-forest-river-1579/1080p.mp4' },
      { id: 'pullup', name: 'Pull-Ups', type: 'calisthenics', muscle: 'Back', difficulty: 'Intermediate', desc: 'Upper body pulling exercise', instructions: '1. Hang from bar, palms away\n2. Pull chin over bar\n3. Lower with control\n4. Full extension at bottom', tips: 'Engage lats, avoid swinging', videoUrl: 'https://cdn.coverr.co/videos/coverr-waterfall-1510/1080p.mp4' },
      { id: 'squat', name: 'Bodyweight Squat', type: 'calisthenics', muscle: 'Legs', difficulty: 'Beginner', desc: 'Fundamental leg exercise', instructions: '1. Feet shoulder-width\n2. Sit back and down\n3. Thighs parallel to ground\n4. Drive through heels', tips: 'Knees track over toes', videoUrl: 'https://cdn.coverr.co/videos/coverr-shore-1576/1080p.mp4' },
      { id: 'dips', name: 'Dips', type: 'calisthenics', muscle: 'Triceps', difficulty: 'Intermediate', desc: 'Tricep and chest developer', instructions: '1. Support on parallel bars\n2. Lower body down\n3. Elbows to 90¬∞\n4. Push back up', tips: 'Lean forward for chest focus', videoUrl: 'https://cdn.coverr.co/videos/coverr-snowy-peaks-1516/1080p.mp4' },
      { id: 'plank', name: 'Plank', type: 'calisthenics', muscle: 'Core', difficulty: 'Beginner', desc: 'Isometric core strengthener', instructions: '1. Forearms on ground\n2. Body in straight line\n3. Hold position\n4. Breathe steady', tips: 'Don\'t let hips sag', videoUrl: 'https://cdn.coverr.co/videos/coverr-mountain-peak-1583/1080p.mp4' },
      { id: 'lunges', name: 'Lunges', type: 'calisthenics', muscle: 'Legs', difficulty: 'Beginner', desc: 'Single-leg strength builder', instructions: '1. Step forward\n2. Lower back knee\n3. Front thigh parallel\n4. Push back to start', tips: 'Keep torso upright', videoUrl: 'https://cdn.coverr.co/videos/coverr-roadtrip-1577/1080p.mp4' },

      // GYM
      { id: 'bench_press', name: 'Barbell Bench Press', type: 'gym', muscle: 'Chest', difficulty: 'Intermediate', desc: 'King of chest exercises', instructions: '1. Lie on bench\n2. Grip bar slightly wider than shoulders\n3. Lower to chest\n4. Press back up', tips: 'Retract shoulder blades, arch back slightly', videoUrl: 'https://cdn.coverr.co/videos/coverr-waterfall-1510/1080p.mp4' },
      { id: 'deadlift', name: 'Deadlift', type: 'gym', muscle: 'Back', difficulty: 'Advanced', desc: 'Full-body power movement', instructions: '1. Bar over mid-foot\n2. Grip bar, hips back\n3. Pull bar up legs\n4. Stand tall, squeeze glutes', tips: 'Keep bar close to body, neutral spine', videoUrl: 'https://cdn.coverr.co/videos/coverr-water-between-icelands-1544/1080p.mp4' },
      { id: 'back_squat', name: 'Back Squat', type: 'gym', muscle: 'Legs', difficulty: 'Advanced', desc: 'Lower body mass builder', instructions: '1. Bar on upper back\n2. Feet shoulder-width\n3. Squat down deep\n4. Drive up through heels', tips: 'Chest up, knees out', videoUrl: 'https://cdn.coverr.co/videos/coverr-night-traffic-1572/1080p.mp4' },
      { id: 'overhead_press', name: 'Overhead Press', type: 'gym', muscle: 'Shoulders', difficulty: 'Intermediate', desc: 'Shoulder strength developer', instructions: '1. Bar at shoulders\n2. Press overhead\n3. Lock out at top\n4. Lower with control', tips: 'Stack wrists over elbows', videoUrl: 'https://cdn.coverr.co/videos/coverr-mountain-lake-1542/1080p.mp4' },
      { id: 'lat_pulldown', name: 'Lat Pulldown', type: 'gym', muscle: 'Back', difficulty: 'Beginner', desc: 'Lat width builder', instructions: '1. Sit at machine\n2. Grip bar wide\n3. Pull to upper chest\n4. Squeeze shoulder blades', tips: 'Don\'t lean back too much', videoUrl: 'https://cdn.coverr.co/videos/coverr-ocean-waves-1582/1080p.mp4' },
      { id: 'leg_press', name: 'Leg Press', type: 'gym', muscle: 'Legs', difficulty: 'Beginner', desc: 'Quad mass builder', instructions: '1. Feet on platform\n2. Lower weight with control\n3. Knees to 90¬∞\n4. Press back up', tips: 'Full range of motion', videoUrl: 'https://cdn.coverr.co/videos/coverr-shore-1576/1080p.mp4' },

      // HOME
      { id: 'burpees', name: 'Burpees', type: 'home', muscle: 'Full Body', difficulty: 'Intermediate', desc: 'Full-body cardio burner', instructions: '1. Stand tall\n2. Drop to plank\n3. Push-up (optional)\n4. Jump feet to hands\n5. Jump up', tips: 'Land softly, maintain pace', videoUrl: 'https://cdn.coverr.co/videos/coverr-ocean-1593/1080p.mp4' },
      { id: 'mountain_climbers', name: 'Mountain Climbers', type: 'home', muscle: 'Core', difficulty: 'Beginner', desc: 'Dynamic core exercise', instructions: '1. Start in plank\n2. Drive knee to chest\n3. Alternate legs quickly\n4. Keep hips level', tips: 'Maintain plank position throughout', videoUrl: 'https://cdn.coverr.co/videos/coverr-trees-1547/1080p.mp4' },
      { id: 'jumping_jacks', name: 'Jumping Jacks', type: 'home', muscle: 'Cardio', difficulty: 'Beginner', desc: 'Cardio warm-up', instructions: '1. Start feet together\n2. Jump feet out, arms up\n3. Jump back to start\n4. Maintain rhythm', tips: 'Land softly on balls of feet', videoUrl: 'https://cdn.coverr.co/videos/coverr-ocean-1593/1080p.mp4' },
      { id: 'pike_pushup', name: 'Pike Push-Ups', type: 'home', muscle: 'Shoulders', difficulty: 'Intermediate', desc: 'Shoulder strength without weights', instructions: '1. Start in downward dog\n2. Bend elbows\n3. Lower head toward ground\n4. Push back up', tips: 'Keep hips high throughout', videoUrl: 'https://cdn.coverr.co/videos/coverr-roadtrip-1577/1080p.mp4' },
      { id: 'glute_bridge', name: 'Glute Bridge', type: 'home', muscle: 'Glutes', difficulty: 'Beginner', desc: 'Glute activation exercise', instructions: '1. Lie on back, knees bent\n2. Lift hips up\n3. Squeeze glutes at top\n4. Lower with control', tips: 'Drive through heels', videoUrl: 'https://cdn.coverr.co/videos/coverr-shore-1576/1080p.mp4' },
      { id: 'wall_sit', name: 'Wall Sit', type: 'home', muscle: 'Legs', difficulty: 'Beginner', desc: 'Isometric leg strengthener', instructions: '1. Back against wall\n2. Slide down to 90¬∞\n3. Hold position\n4. Breathe steady', tips: 'Thighs parallel to ground', videoUrl: 'https://cdn.coverr.co/videos/coverr-mountain-peak-1583/1080p.mp4' },
    ];

    const achievements = [
      { id: 'first_task', name: 'First Steps', desc: 'Complete first task', icon: 'üéØ', check: (s) => Object.keys(s.completed).length > 0, reward: {xp: 100, coins: 10} },
      { id: 'level_5', name: 'Novice', desc: 'Reach Level 5', icon: 'üå±', check: (s) => computeLevel(s.xp).level >= 5, reward: {xp: 200, coins: 20} },
      { id: 'level_10', name: 'Apprentice', desc: 'Reach Level 10', icon: '‚öîÔ∏è', check: (s) => computeLevel(s.xp).level >= 10, reward: {xp: 500, coins: 50} },
      { id: 'streak_7', name: 'Week Warrior', desc: '7-day streak', icon: 'üî•', check: (s) => s.streak >= 7, reward: {xp: 300, coins: 30} },
      { id: 'streak_30', name: 'Iron Will', desc: '30-day streak', icon: 'üí™', check: (s) => s.streak >= 30, reward: {xp: 1500, coins: 150} },
      { id: 'perfect_day', name: 'Perfect Day', desc: 'Complete all dailies', icon: 'üéâ', check: (s) => dailyTasks.every(t => s.completed[t.id]), reward: {xp: 250, coins: 25} },
      { id: 'nutrition_master', name: 'Nutrition Master', desc: 'Log 50 foods', icon: 'üçé', check: (s) => (s.foodLogs || []).length >= 50, reward: {xp: 500, coins: 50} },
      { id: 'balanced_diet', name: 'Balanced Diet', desc: 'Hit calorie target 7 days straight', icon: '‚öñÔ∏è', check: (s) => false, reward: {xp: 300, coins: 30} },
    ];

    const storeItems = [
      { id: 'cheat_meal', name: 'Cheat Meal Pass', cost: 300, desc: 'Guilt-free indulgence', usable: true },
      { id: 'rest_pass', name: 'Rest Day Pass', cost: 600, desc: 'Skip without losing streak', usable: true },
      { id: 'xp_boost', name: 'XP Boost (24h)', cost: 500, desc: '+50% XP', usable: true },
      { id: 'streak_shield', name: 'Streak Shield', cost: 800, desc: 'Protect streak once', usable: true },
      { id: 'movie_night', name: 'Movie Night', cost: 200, desc: 'Relax time', usable: true },
    ];

    // ============= HELPER FUNCTIONS =============
    function getTodayDateString() {
      const tz = "America/New_York";
      const formatter = new Intl.DateTimeFormat("en-US", { timeZone: tz, year: "numeric", month: "2-digit", day: "2-digit" });
      const parts = formatter.formatToParts(new Date());
      const year = parts.find(p => p.type === 'year')?.value || '';
      const month = parts.find(p => p.type === 'month')?.value || '';
      const day = parts.find(p => p.type === 'day')?.value || '';
      return `${year}-${month}-${day}`;
    }

    function secondsToEasternMidnight() {
      const tz = "America/New_York";
      const now = new Date();
      const parts = new Intl.DateTimeFormat("en-US", {
        timeZone: tz, year: "numeric", month: "2-digit", day: "2-digit",
        hour: "2-digit", minute: "2-digit", second: "2-digit", hour12: false
      }).formatToParts(now);
      const get = (t) => Number(parts.find((p) => p.type === t)?.value || "0");
      const y = get("year"), m = get("month"), d = get("day");
      const h = get("hour"), min = get("minute"), s = get("second");
      const easternNow = Date.UTC(y, m - 1, d, h, min, s);
      const nextEasternMidnight = Date.UTC(y, m - 1, d + 1, 0, 0, 0);
      return Math.max(0, Math.floor((nextEasternMidnight - easternNow) / 1000));
    }

    function computeLevel(xp) {
      let level = 1, pool = xp;
      while (pool >= Math.round(100 * Math.pow(level, 1.2))) {
        pool -= Math.round(100 * Math.pow(level, 1.2));
        level++;
      }
      const need = Math.round(100 * Math.pow(level, 1.2));
      return { level, current: pool, need, pct: (pool / need) * 100 };
    }

    function rollLoot() {
      const rolls = [
        { r: 'common', items: [{ name: '+50 XP', type: 'xp', v: 50 }, { name: '+10 coins', type: 'coins', v: 10 }], chance: 0.7 },
        { r: 'uncommon', items: [{ name: '+100 XP', type: 'xp', v: 100 }, { name: '+25 coins', type: 'coins', v: 25 }], chance: 0.2 },
        { r: 'rare', items: [{ name: '+250 XP', type: 'xp', v: 250 }], chance: 0.08 },
        { r: 'epic', items: [{ name: '+500 XP', type: 'xp', v: 500 }], chance: 0.018 },
        { r: 'legendary', items: [{ name: '+1000 XP!', type: 'xp', v: 1000 }], chance: 0.002 },
      ];
      const loot = [];
      for (let i = 0; i < 2; i++) {
        const roll = Math.random();
        let cum = 0;
        for (const {r, items, chance} of rolls) {
          cum += chance;
          if (roll < cum) {
            const item = items[Math.floor(Math.random() * items.length)];
            loot.push({ ...item, rarity: r });
            break;
          }
        }
      }
      return loot;
    }

    function pickMission(exclude) {
      const pool = missionPool.filter(m => m.id !== exclude);
      return pool[Math.floor(Math.random() * pool.length)];
    }

    function fmtTime(secs) {
      const h = Math.floor(secs / 3600).toString().padStart(2, '0');
      const m = Math.floor((secs % 3600) / 60).toString().padStart(2, '0');
      const s = Math.floor(secs % 60).toString().padStart(2, '0');
      return `${h}:${m}:${s}`;
    }

    function save(state) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        localStorage.setItem(STORAGE_DATE_KEY, getTodayDateString());
      } catch (e) { console.warn('Save failed:', e); }
    }

    function load() {
      try {
        const data = localStorage.getItem(STORAGE_KEY);
        return data ? JSON.parse(data) : null;
      } catch (e) { return null; }
    }

    function applyPenalty(state) {
      const allCompleted = dailyTasks.every(t => state.completed[t.id]);
      if (allCompleted) {
        return { ...state, streak: state.streak + 1, lastPenaltyMessage: null };
      }
      const hasStreakShield = state.inventory.streak_shield > 0;
      if (hasStreakShield) {
        return {
          ...state,
          inventory: { ...state.inventory, streak_shield: state.inventory.streak_shield - 1 },
          lastPenaltyMessage: 'üõ°Ô∏è Streak Shield Used! Protected.',
        };
      }
      const newStats = { ...state.stats };
      Object.keys(newStats).forEach(key => { newStats[key] = Math.max(0, newStats[key] - PENALTY_STAT_DECAY); });
      return {
        ...state,
        xp: Math.max(0, state.xp - PENALTY_XP_LOSS),
        coins: Math.max(0, state.coins - PENALTY_COIN_LOSS),
        stats: newStats,
        streak: 0,
        lastPenaltyMessage: `‚ö†Ô∏è PENALTY: -${PENALTY_XP_LOSS} XP, -${PENALTY_COIN_LOSS} coins, -${PENALTY_STAT_DECAY} all stats, streak reset.`,
      };
    }

    // ============= COMPONENTS =============
    const ExerciseCard = ({ exercise, onView }) => (
      <div className="bg-white/5 border border-white/10 rounded-xl overflow-hidden hover:bg-white/10 transition-all">
        <video src={exercise.videoUrl} className="w-full h-32 object-cover" muted loop autoPlay playsInline />
        <div className="p-3">
          <div className="flex items-center justify-between mb-1">
            <h3 className="font-semibold text-sm">{exercise.name}</h3>
            <span className={`text-[10px] px-2 py-0.5 rounded-full ${
              exercise.difficulty === 'Beginner' ? 'bg-green-500/20 text-green-300' :
              exercise.difficulty === 'Intermediate' ? 'bg-yellow-500/20 text-yellow-300' :
              'bg-red-500/20 text-red-300'
            }`}>{exercise.difficulty}</span>
          </div>
          <p className="text-xs text-slate-400 mb-2">{exercise.muscle} ‚Ä¢ {exercise.type}</p>
          <button onClick={() => onView(exercise)} className="text-xs px-3 py-1 rounded bg-sky-500 hover:bg-sky-400 text-white w-full">
            View Details
          </button>
        </div>
      </div>
    );

    const ExerciseDetail = ({ exercise, onClose }) => (
      <div className="fixed inset-0 bg-black/90 flex items-center justify-center p-4 z-50 animate-fadeIn overflow-auto" onClick={onClose}>
        <div className="bg-slate-900 border-2 border-sky-500 rounded-2xl p-6 max-w-2xl w-full animate-scaleIn max-h-[90vh] overflow-auto" onClick={e => e.stopPropagation()}>
          <h2 className="text-2xl font-bold mb-4 text-sky-400">{exercise.name}</h2>
          <video src={exercise.videoUrl} className="w-full h-64 object-cover rounded-lg mb-4" controls autoPlay loop />
          <div className="grid grid-cols-3 gap-2 mb-4">
            <div className="bg-white/5 rounded p-2">
              <p className="text-xs text-slate-400">Type</p>
              <p className="font-semibold capitalize">{exercise.type}</p>
            </div>
            <div className="bg-white/5 rounded p-2">
              <p className="text-xs text-slate-400">Muscle</p>
              <p className="font-semibold">{exercise.muscle}</p>
            </div>
            <div className="bg-white/5 rounded p-2">
              <p className="text-xs text-slate-400">Difficulty</p>
              <p className="font-semibold">{exercise.difficulty}</p>
            </div>
          </div>
          <div className="mb-4">
            <h3 className="font-bold mb-2">üìã Instructions</h3>
            <p className="text-sm text-slate-300 whitespace-pre-line">{exercise.instructions}</p>
          </div>
          <div className="mb-4 bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-3">
            <h3 className="font-bold text-yellow-400 mb-1">üí° Pro Tips</h3>
            <p className="text-sm text-slate-300">{exercise.tips}</p>
          </div>
          <button onClick={onClose} className="w-full py-2 rounded-lg bg-sky-500 hover:bg-sky-400 text-white font-bold">
            Close
          </button>
        </div>
      </div>
    );

    // Main app continues in next section...
    // Due to file size, I'll split this into focused functional chunks

    function NutritionTab({ state, updateState }) {
      const [search, setSearch] = useState('');
      const [selectedFood, setSelectedFood] = useState(null);
      const [quantity, setQuantity] = useState(1);
      const [manualCalories, setManualCalories] = useState('');
      const [manualName, setManualName] = useState('');

      const filtered = foodDatabase.filter(f =>
        f.name.toLowerCase().includes(search.toLowerCase()) ||
        f.category.toLowerCase().includes(search.toLowerCase())
      );

      const totalCalories = (state.foodLogs || []).reduce((sum, log) => sum + log.calories, 0);
      const progress = Math.min(100, (totalCalories / DAILY_KCAL_TARGET) * 100);
      const hitTarget = totalCalories >= DAILY_KCAL_TARGET * 0.9 && totalCalories <= DAILY_KCAL_TARGET * 1.1;

      const logFood = (food, qty) => {
        const calories = food.calories * qty;
        updateState(prev => ({
          ...prev,
          foodLogs: [...(prev.foodLogs || []), { ...food, quantity: qty, calories, timestamp: Date.now() }],
          xp: prev.xp + XP_PER_FOOD_LOG,
          coins: prev.coins + Math.floor(XP_PER_FOOD_LOG / XP_PER_COIN),
          stats: { ...prev.stats, discipline: (prev.stats.discipline || 0) + 1 },
        }));
        setSelectedFood(null);
        setQuantity(1);
      };

      const logManual = () => {
        if (!manualName || !manualCalories) return;
        const calories = parseInt(manualCalories);
        updateState(prev => ({
          ...prev,
          foodLogs: [...(prev.foodLogs || []), {
            id: 'manual_' + Date.now(),
            name: manualName,
            calories,
            quantity: 1,
            category: 'Manual',
            timestamp: Date.now()
          }],
          xp: prev.xp + XP_PER_FOOD_LOG,
          coins: prev.coins + Math.floor(XP_PER_FOOD_LOG / XP_PER_COIN),
          stats: { ...prev.stats, discipline: (prev.stats.discipline || 0) + 1 },
        }));
        setManualName('');
        setManualCalories('');
      };

      return (
        <div className="space-y-4">
          <div className="bg-white/10 backdrop-blur-xl rounded-2xl border border-white/20 p-4">
            <h2 className="font-bold mb-3">üçé Daily Nutrition</h2>
            <div className="mb-3">
              <div className="flex justify-between text-sm mb-1">
                <span className="text-slate-300">{Math.round(totalCalories)} / {DAILY_KCAL_TARGET} kcal</span>
                <span className="text-slate-400">{Math.round(progress)}%</span>
              </div>
              <div className="w-full h-4 rounded-full bg-white/10 border border-white/20 overflow-hidden">
                <div className={`h-full transition-all duration-500 ${hitTarget ? 'bg-gradient-to-r from-green-400 to-emerald-500' : 'bg-gradient-to-r from-sky-400 to-blue-500'}`} style={{ width: `${progress}%` }} />
              </div>
              {hitTarget && (
                <p className="text-xs text-green-400 mt-2">üéâ Perfect nutrition! +{XP_FOR_HITTING_TARGET} bonus XP at midnight!</p>
              )}
            </div>

            <div className="space-y-2 max-h-40 overflow-auto">
              {(state.foodLogs || []).slice(-5).reverse().map((log, i) => (
                <div key={i} className="flex items-center justify-between text-xs bg-white/5 rounded p-2">
                  <span>{log.name} {log.quantity > 1 && `√ó${log.quantity}`}</span>
                  <span className="text-slate-300">{log.calories} kcal</span>
                </div>
              ))}
              {!(state.foodLogs || []).length && <p className="text-xs text-slate-500">No entries yet. Start logging!</p>}
            </div>
          </div>

          <div className="bg-white/10 backdrop-blur-xl rounded-2xl border border-white/20 p-4">
            <h2 className="font-bold mb-3">‚ûï Log Food</h2>

            <div className="mb-4">
              <h3 className="text-sm font-semibold mb-2">Quick Add from Database</h3>
              <input
                type="text"
                placeholder="Search foods..."
                value={search}
                onChange={(e) => setSearch(e.target.value)}
                className="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/20 text-sm mb-2"
              />
              <div className="grid grid-cols-1 gap-2 max-h-48 overflow-auto">
                {filtered.slice(0, 10).map(food => (
                  <button
                    key={food.id}
                    onClick={() => setSelectedFood(food)}
                    className="text-left p-2 rounded-lg bg-white/5 hover:bg-white/10 border border-white/10 transition-all"
                  >
                    <div className="flex justify-between items-center">
                      <div>
                        <p className="text-sm font-medium">{food.name}</p>
                        <p className="text-xs text-slate-400">{food.category} ‚Ä¢ {food.calories} kcal</p>
                      </div>
                      <span className="text-sky-400 text-xl">+</span>
                    </div>
                  </button>
                ))}
              </div>
            </div>

            <div className="border-t border-white/10 pt-4">
              <h3 className="text-sm font-semibold mb-2">Manual Entry</h3>
              <input
                type="text"
                placeholder="Food name..."
                value={manualName}
                onChange={(e) => setManualName(e.target.value)}
                className="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/20 text-sm mb-2"
              />
              <div className="flex gap-2">
                <input
                  type="number"
                  placeholder="Calories..."
                  value={manualCalories}
                  onChange={(e) => setManualCalories(e.target.value)}
                  className="flex-1 px-3 py-2 rounded-lg bg-white/5 border border-white/20 text-sm"
                />
                <button
                  onClick={logManual}
                  disabled={!manualName || !manualCalories}
                  className="px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white text-sm disabled:opacity-50"
                >
                  Add +{XP_PER_FOOD_LOG} XP
                </button>
              </div>
            </div>
          </div>

          {selectedFood && (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => setSelectedFood(null)}>
              <div className="bg-slate-900 border-2 border-emerald-500 rounded-2xl p-6 max-w-md animate-scaleIn" onClick={e => e.stopPropagation()}>
                <h2 className="text-xl font-bold mb-4">{selectedFood.name}</h2>
                <div className="grid grid-cols-2 gap-2 mb-4">
                  <div className="bg-white/5 rounded p-2">
                    <p className="text-xs text-slate-400">Calories</p>
                    <p className="font-bold text-lg">{selectedFood.calories}</p>
                  </div>
                  <div className="bg-white/5 rounded p-2">
                    <p className="text-xs text-slate-400">Protein</p>
                    <p className="font-bold">{selectedFood.protein}g</p>
                  </div>
                  <div className="bg-white/5 rounded p-2">
                    <p className="text-xs text-slate-400">Carbs</p>
                    <p className="font-bold">{selectedFood.carbs}g</p>
                  </div>
                  <div className="bg-white/5 rounded p-2">
                    <p className="text-xs text-slate-400">Fats</p>
                    <p className="font-bold">{selectedFood.fats}g</p>
                  </div>
                </div>
                <div className="mb-4">
                  <label className="text-sm text-slate-300 block mb-2">Quantity:</label>
                  <input
                    type="number"
                    min="1"
                    value={quantity}
                    onChange={(e) => setQuantity(Math.max(1, parseInt(e.target.value) || 1))}
                    className="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/20"
                  />
                  <p className="text-xs text-slate-400 mt-1">Total: {selectedFood.calories * quantity} kcal</p>
                </div>
                <div className="flex gap-2">
                  <button onClick={() => setSelectedFood(null)} className="flex-1 py-2 rounded-lg bg-white/10 hover:bg-white/20">
                    Cancel
                  </button>
                  <button onClick={() => logFood(selectedFood, quantity)} className="flex-1 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 font-bold">
                    Log +{XP_PER_FOOD_LOG} XP
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    function LibraryTab() {
      const [typeFilter, setTypeFilter] = useState('all');
      const [muscleFilter, setMuscleFilter] = useState('all');
      const [selectedExercise, setSelectedExercise] = useState(null);

      const muscles = ['All', 'Chest', 'Back', 'Legs', 'Shoulders', 'Core', 'Triceps', 'Full Body', 'Cardio', 'Glutes'];
      const types = ['All', 'Calisthenics', 'Gym', 'Home'];

      const filtered = exerciseLibrary.filter(ex => {
        const matchType = typeFilter === 'all' || ex.type === typeFilter;
        const matchMuscle = muscleFilter === 'all' || ex.muscle === muscleFilter;
        return matchType && matchMuscle;
      });

      return (
        <div className="space-y-4">
          <div className="bg-white/10 backdrop-blur-xl rounded-2xl border border-white/20 p-4">
            <h2 className="font-bold mb-3">üìö Exercise Library</h2>

            <div className="mb-4">
              <p className="text-xs text-slate-400 mb-2">Filter by Type:</p>
              <div className="flex gap-2 flex-wrap">
                {types.map(type => (
                  <button
                    key={type}
                    onClick={() => setTypeFilter(type.toLowerCase())}
                    className={`px-3 py-1 rounded-lg text-xs ${
                      typeFilter === type.toLowerCase()
                        ? 'bg-sky-500 text-white'
                        : 'bg-white/5 border border-white/10 hover:bg-white/10'
                    }`}
                  >
                    {type}
                  </button>
                ))}
              </div>
            </div>

            <div className="mb-4">
              <p className="text-xs text-slate-400 mb-2">Filter by Muscle:</p>
              <div className="flex gap-2 flex-wrap">
                {muscles.map(muscle => (
                  <button
                    key={muscle}
                    onClick={() => setMuscleFilter(muscle)}
                    className={`px-2 py-1 rounded-lg text-xs ${
                      muscleFilter === muscle
                        ? 'bg-purple-500 text-white'
                        : 'bg-white/5 border border-white/10 hover:bg-white/10'
                    }`}
                  >
                    {muscle}
                  </button>
                ))}
              </div>
            </div>

            <p className="text-xs text-slate-400 mb-3">{filtered.length} exercises found</p>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-3 max-h-96 overflow-auto">
              {filtered.map(ex => (
                <ExerciseCard key={ex.id} exercise={ex} onView={setSelectedExercise} />
              ))}
            </div>
          </div>

          {selectedExercise && (
            <ExerciseDetail exercise={selectedExercise} onClose={() => setSelectedExercise(null)} />
          )}
        </div>
      );
    }

    // Import other components from previous version (CountdownTimer, LootModal, etc.)
    // For brevity, I'll include the main app structure

    function SENSE() {
      // State management similar to previous version...
      const [state, setState] = useState(() => {
        const saved = load();
        const lastDate = localStorage.getItem(STORAGE_DATE_KEY);
        const today = getTodayDateString();
        if (saved && lastDate !== today) {
          const penalized = applyPenalty(saved);
          return { ...penalized, completed: {}, missions: Array(4).fill(null).map(() => ({ mission: pickMission(), endTime: 0 })), foodLogs: [] };
        }
        return saved || {
          characterClass: null, completed: {}, xp: 0, coins: 0,
          stats: { strength: 0, endurance: 0, intelligence: 0, charisma: 0, discipline: 0, wealth: 0 },
          streak: 0, missions: Array(4).fill(null).map(() => ({ mission: pickMission(), endTime: 0 })),
          unlocked: [], inventory: {}, lastAction: null, lastPenaltyMessage: null, foodLogs: []
        };
      });

      const [tab, setTab] = useState('quests');
      const [remaining, setRemaining] = useState(secondsToEasternMidnight());

      useEffect(() => { save(state); }, [state]);
      useEffect(() => {
        const timer = setInterval(() => setRemaining(secondsToEasternMidnight()), 1000);
        return () => clearInterval(timer);
      }, []);

      const levelInfo = useMemo(() => computeLevel(state.xp), [state.xp]);
      const updateState = useCallback((updater) => setState(prev => updater(prev)), []);

      if (!state.characterClass) {
        return <div className="min-h-screen bg-slate-950 text-slate-100 p-6 flex items-center justify-center">
          <div className="text-center">
            <h1 className="text-3xl font-bold text-sky-400 mb-8">Choose Your Character Class</h1>
            <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
              {Object.entries(characterClasses).map(([key, cls]) => (
                <button
                  key={key}
                  onClick={() => updateState(prev => ({ ...prev, characterClass: key }))}
                  className="p-6 rounded-xl border-2 border-white/20 bg-white/5 hover:bg-white/10 hover:border-sky-400 transition-all"
                >
                  <div className="text-5xl mb-3">{cls.icon}</div>
                  <h3 className="font-bold text-lg">{cls.name}</h3>
                  <p className="text-sm text-slate-400">{cls.desc}</p>
                </button>
              ))}
            </div>
          </div>
        </div>;
      }

      const classInfo = characterClasses[state.characterClass];
      const tasksRemaining = dailyTasks.filter(t => !state.completed[t.id]).length;

      // Countdown timer component (simplified inline)
      const isUrgent = remaining <= 3600;
      const isCritical = remaining <= 900;

      return (
        <div className="min-h-screen bg-slate-950 text-slate-100 p-6">
          {/* Countdown */}
          <div className={`max-w-md mx-auto mb-4 p-4 rounded-xl border-2 ${
            isCritical ? 'bg-red-600/40 border-red-500 animate-pulse' :
            isUrgent ? 'bg-orange-600/30 border-orange-500' :
            'bg-white/10 border-white/20'
          }`}>
            <div className="flex items-center justify-between">
              <div>
                <h3 className="font-bold text-sm text-white">
                  {isCritical ? 'üö® URGENT!' : isUrgent ? '‚ö†Ô∏è WARNING!' : '‚è≥ Time to Midnight'}
                </h3>
                <p className="text-xs text-white/80">{tasksRemaining} tasks remaining</p>
              </div>
              <div className="text-2xl font-bold font-mono text-white">{fmtTime(remaining)}</div>
            </div>
          </div>

          {/* Header */}
          <div className="max-w-md mx-auto mb-4">
            <div className="flex items-center justify-between mb-2">
              <div className="flex items-center gap-3">
                <div className="h-12 w-12 rounded-2xl bg-gradient-to-br from-sky-400 to-blue-600 flex items-center justify-center">
                  <span className="text-2xl">{classInfo.icon}</span>
                </div>
                <div>
                  <h1 className="text-xl font-bold text-sky-400">SENSE</h1>
                  <p className="text-xs text-slate-400">Level {levelInfo.level} {classInfo.name}</p>
                </div>
              </div>
              <div className="text-right">
                <div className="text-sm px-2 py-1 rounded-full bg-emerald-500/20 border border-emerald-400/40 text-emerald-200 font-bold">
                  üí∞ {state.coins}
                </div>
                {state.streak > 0 && (
                  <div className="text-xs px-2 py-0.5 rounded-full bg-orange-500/20 text-orange-200 mt-1">
                    üî• {state.streak}
                  </div>
                )}
              </div>
            </div>
            <div className="w-full h-4 rounded-full bg-white/10 overflow-hidden mb-2">
              <div className="h-full bg-gradient-to-r from-sky-400 to-purple-500" style={{ width: `${levelInfo.pct}%` }} />
            </div>
            <div className="grid grid-cols-6 gap-1 text-center">
              {Object.entries(state.stats).map(([k, v]) => (
                <div key={k} className="bg-white/5 rounded p-1">
                  <div className="text-[9px] text-slate-400 uppercase">{k.slice(0,3)}</div>
                  <div className="text-xs font-bold">{v}</div>
                </div>
              ))}
            </div>
          </div>

          {/* Tabs */}
          <div className="max-w-md mx-auto flex gap-2 mb-4 overflow-x-auto">
            {['quests', 'nutrition', 'library', 'character', 'store'].map(t => (
              <button
                key={t}
                onClick={() => setTab(t)}
                className={`px-3 py-1.5 rounded-xl border text-xs whitespace-nowrap ${tab === t ? 'bg-white/20 border-white/30' : 'bg-white/5 border-white/10'}`}
              >
                {t === 'quests' && '‚öîÔ∏è'} {t === 'nutrition' && 'üçé'} {t === 'library' && 'üìö'}
                {t === 'character' && 'üéØ'} {t === 'store' && 'üõí'} {t.charAt(0).toUpperCase() + t.slice(1)}
              </button>
            ))}
          </div>

          {/* Content */}
          <div className="max-w-md mx-auto">
            {tab === 'nutrition' && <NutritionTab state={state} updateState={updateState} />}
            {tab === 'library' && <LibraryTab />}
            {/* Other tabs similar to previous version */}
            {tab === 'quests' && (
              <div className="bg-white/10 backdrop-blur-xl rounded-2xl border border-white/20 p-4">
                <h2 className="font-bold mb-3">üìã Daily Quests ({dailyTasks.length - tasksRemaining}/{dailyTasks.length})</h2>
                <p className="text-xs text-slate-500">Complete tasks to earn XP, coins, and increase stats!</p>
              </div>
            )}
            {tab === 'character' && (
              <div className="bg-white/10 backdrop-blur-xl rounded-2xl border border-white/20 p-4">
                <h2 className="font-bold mb-3">üéØ Character Sheet</h2>
                <div className="text-center mb-4">
                  <div className="text-6xl mb-2">{classInfo.icon}</div>
                  <h3 className="text-xl font-bold text-sky-400">{classInfo.name}</h3>
                  <p className="text-sm text-slate-400">Level {levelInfo.level} ‚Ä¢ {state.streak} day streak</p>
                </div>
              </div>
            )}
            {tab === 'store' && (
              <div className="bg-white/10 backdrop-blur-xl rounded-2xl border border-white/20 p-4">
                <h2 className="font-bold mb-3">üõí Store</h2>
                <p className="text-xs text-slate-500 mb-3">Buy power-ups and rewards with your coins!</p>
                {storeItems.map(item => (
                  <div key={item.id} className="flex items-center justify-between border-b border-white/10 pb-2 mb-2 last:border-0">
                    <div>
                      <p className="text-sm font-medium">{item.name}</p>
                      <p className="text-xs text-slate-400">{item.desc}</p>
                      <p className="text-xs text-slate-500">{item.cost} coins</p>
                    </div>
                    <button className="text-xs px-3 py-1 rounded bg-emerald-600 hover:bg-emerald-500 disabled:opacity-50">
                      Buy
                    </button>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<SENSE />);
  </script>
</body>
</html>
