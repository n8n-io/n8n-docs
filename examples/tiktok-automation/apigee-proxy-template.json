{
  "name": "tiktok-publish-proxy-template",
  "description": "Plantilla de bundle para Apigee: endpoint /publish que obtiene token de TikTok, sube video y retorna resultado. Ajustar client_key/client_secret en KVM o Secret Manager.",
  "proxyEndpoint.xml": "<ProxyEndpoint name=\"default\">\n  <HTTPProxyConnection>\n    <BasePath>/publish</BasePath>\n    <VirtualHost>default</VirtualHost>\n  </HTTPProxyConnection>\n  <PreFlow>\n    <Request>\n      <!-- Verifica header x-api-key opcionalmente mediante VerifyAPIKey o KVM lookup -->\n    </Request>\n    <Response/>\n  </PreFlow>\n  <Flows/>\n  <PostFlow>\n    <Request/>\n    <Response/>\n  </PostFlow>\n</ProxyEndpoint>",
  "targetEndpoint.xml": "<TargetEndpoint name=\"default\">\n  <Description>TikTok uploader target (usado sólo para ServiceCallout a token endpoint si se necesita)</Description>\n  <HTTPTargetConnection>\n    <URL>https://open-api.tiktok.com</URL>\n  </HTTPTargetConnection>\n</TargetEndpoint>",
  "policies": {
    "GetTikTokToken.xml": "<ServiceCallout name=\"GetTikTokToken\">\n  <Request clearPayload=\"true\">\n    <Set>\n      <Verb>POST</Verb>\n      <Path>/oauth2/token/</Path>\n      <Headers>\n        <Header name=\"Content-Type\">application/x-www-form-urlencoded</Header>\n      </Headers>\n      <FormParams>\n        <FormParam name=\"client_key\">{CLIENT_KEY}</FormParam>\n        <FormParam name=\"client_secret\">{CLIENT_SECRET}</FormParam>\n        <FormParam name=\"grant_type\">client_credentials</FormParam>\n      </FormParams>\n    </Set>\n  </Request>\n  <Response>tokenResponse</Response>\n  <HTTPTargetConnection>\n    <URL>https://open-api.tiktok.com</URL>\n  </HTTPTargetConnection>\n</ServiceCallout>",

    "ExtractToken.xml": "<ExtractVariables name=\"ExtractTikTokToken\">\n  <Source>tokenResponse</Source>\n  <JSONPayload>\n    <Variable name=\"access_token\">\n      <JSONPath>$.access_token</JSONPath>\n    </Variable>\n    <Variable name=\"expires_in\">\n      <JSONPath>$.expires_in</JSONPath>\n    </Variable>\n  </JSONPayload>\n</ExtractVariables>",

    "SetAuthHeader.xml": "<AssignMessage name=\"SetAuthHeader\">\n  <AssignTo createNew=\"false\" type=\"request\"/>\n  <Set>\n    <Headers>\n      <Header name=\"Authorization\">Bearer {access_token}</Header>\n    </Headers>\n  </Set>\n  <IgnoreUnresolvedVariables>true</IgnoreUnresolvedVariables>\n</AssignMessage>",

    "UploadToTikTok.xml": "<ServiceCallout name=\"UploadToTikTok\">\n  <Request>\n    <Set>\n      <Verb>POST</Verb>\n      <!-- Path y parámetros deben ajustarse a la API de subida de la cuenta/app -->\n      <Path>/video/upload/</Path>\n      <Headers>\n        <Header name=\"Content-Type\">multipart/form-data</Header>\n        <Header name=\"Authorization\">{request.header.Authorization}</Header>\n      </Headers>\n    </Set>\n  </Request>\n  <Response>uploadResponse</Response>\n  <HTTPTargetConnection>\n    <URL>https://open-api.tiktok.com</URL>\n  </HTTPTargetConnection>\n</ServiceCallout>"
  },
  "exampleProxyFlow": "<!-- Ejemplo de flujo que se puede usar en ProxyEndpoint > PreFlow Request -->\n<Step><Name>GetTikTokToken</Name></Step>\n<!-- Extrae token desde la respuesta del ServiceCallout -->\n<Step><Name>ExtractTikTokToken</Name></Step>\n<!-- Asigna header Authorization para siguientes llamadas -->\n<Step><Name>SetAuthHeader</Name></Step>\n<!-- Realiza la subida final a TikTok -->\n<Step><Name>UploadToTikTok</Name></Step>",
  "notes": "Recomendaciones: 1) Reemplaza {CLIENT_KEY}/{CLIENT_SECRET} por variables alojadas en KVM o en Secret Manager. 2) Ajusta los Paths de token y upload conforme a la versión de la API TikTok que uses. 3) Incluye validaciones y límites: Quota, size limit, tiempos de espera, y logging. 4) Prueba en entorno sandbox/QA antes de producción."
}
